(function(h){var F=h.Markdown=function F(r){switch(typeof r){case"undefined":this.dialect=F.dialects.Gruber;break;case"object":this.dialect=r;break;default:if(r in F.dialects){this.dialect=F.dialects[r]}else{throw new Error("Unknown Markdown dialect '"+String(r)+"'")}break}this.em_state=[];this.strong_state=[];this.debug_indent=""};h.parse=function(s,t){var r=new F(t);return r.toTree(s)};h.toHTML=function V(r,u,s){var t=h.toHTMLTree(r,u,s);return h.renderJsonML(t)};h.toHTMLTree=function g(u,v,t){if(typeof u==="string"){u=this.parse(u,v)}var s=E(u),w={};if(s&&s.references){w=s.references}var r=I(u,w,t);o(r);return r};function T(){return"Markdown.mk_block( "+uneval(this.toString())+", "+uneval(this.trailing)+", "+uneval(this.lineNumber)+" )"}function S(){var r=require("util");return"Markdown.mk_block( "+r.inspect(this.toString())+", "+r.inspect(this.trailing)+", "+r.inspect(this.lineNumber)+" )"}var H=F.mk_block=function(v,r,u){if(arguments.length==1){r="\n\n"}var t=new String(v);t.trailing=r;t.inspect=S;t.toSource=T;if(u!=undefined){t.lineNumber=u}return t};function B(t){var s=0,r=-1;while((r=t.indexOf("\n",r+1))!==-1){s++}return s}F.prototype.split_blocks=function X(u,v){var s=/([\s\S]+?)($|\n(?:\s*\n|$)+)/g,r=[],t;var w=1;if((t=/^(\s*\n)/.exec(u))!=null){w+=B(t[0]);s.lastIndex=t[0].length}while((t=s.exec(u))!==null){r.push(H(t[1],t[2],w));w+=B(t[0])}return r};F.prototype.processBlock=function i(w,t){var u=this.dialect.block,s=u.__order__;if("__call__" in u){return u.__call__.call(this,w,t)}for(var r=0;r<s.length;r++){var v=u[s[r]].call(this,w,t);if(v){if(!m(v)||(v.length>0&&!(m(v[0])))){this.debug(s[r],"didn't return a proper array")}return v}}return[]};F.prototype.processInline=function f(r){return this.dialect.inline.__call__.call(this,String(r))};F.prototype.toTree=function l(s,u){var r=s instanceof Array?s:this.split_blocks(s);var v=this.tree;try{this.tree=u||this.tree||["markdown"];r:while(r.length){var t=this.processBlock(r.shift(),r);if(!t.length){continue r}this.tree.push.apply(this.tree,t)}return this.tree}finally{if(u){this.tree=v}}};F.prototype.debug=function(){var r=Array.prototype.slice.call(arguments);r.unshift(this.debug_indent);if(typeof print!=="undefined"){print.apply(print,r)}if(typeof console!=="undefined"&&typeof console.log!=="undefined"){console.log.apply(null,r)}};F.prototype.loop_re_over_block=function(s,v,r){var t,u=v.valueOf();while(u.length&&(t=s.exec(u))!=null){u=u.substr(t[0].length);r.call(this,t)}return u};F.dialects={};F.dialects.Gruber={block:{atxHeader:function Q(u,s){var t=u.match(/^(#{1,6})\s*(.*?)\s*#*\s*(?:\n|$)/);if(!t){return undefined}var r=["header",{level:t[1].length}];Array.prototype.push.apply(r,this.processInline(t[2]));if(t[0].length<u.length){s.unshift(H(u.substr(t[0].length),u.trailing,u.lineNumber+2))}return[r]},setextHeader:function P(v,t){var u=v.match(/^(.*)\n([-=])\2\2+(?:\n|$)/);if(!u){return undefined}var s=(u[2]==="=")?1:2;var r=["header",{level:s},u[1]];if(u[0].length<v.length){t.unshift(H(v.substr(u[0].length),v.trailing,v.lineNumber+2))}return[r]},code:function e(w,s){var t=[],r=/^(?: {0,3}\t| {4})(.*)\n?/,v;if(!w.match(r)){return undefined}block_search:do{var u=this.loop_re_over_block(r,w.valueOf(),function(x){t.push(x[1])});if(u.length){s.unshift(H(u,w.trailing));break block_search}else{if(s.length){if(!s[0].match(r)){break block_search}t.push(w.trailing.replace(/[^\n]/g,"").substring(2));w=s.shift()}else{break block_search}}}while(true);return[["code_block",t.join("\n")]]},horizRule:function R(u,s){var t=u.match(/^(?:([\s\S]*?)\n)?[ \t]*([-_*])(?:[ \t]*\2){2,}[ \t]*(?:\n([\s\S]*))?$/);if(!t){return undefined}var r=[["hr"]];if(t[1]){r.unshift.apply(r,this.processBlock(t[1],[]))}if(t[3]){s.unshift(H(t[3]))}return r},lists:(function(){var s="[*+-]|\\d+\\.",u=/[*+-]/,w=/\d+\./,t=new RegExp("^( {0,3})("+s+")[ \t]+"),x="(?: {0,3}\\t| {4})";function r(Ab){return new RegExp("(?:^("+x+"{0,"+Ab+"} {0,3})("+s+")\\s+)|(^"+x+"{0,"+(Ab-1)+"}[ ]{0,4})")}function Aa(Ab){return Ab.replace(/ {0,3}\t/g,"    ")}function z(Ad,Af,Ab,Ai){if(Af){Ad.push(["para"].concat(Ab));return}var Ah=Ad[Ad.length-1] instanceof Array&&Ad[Ad.length-1][0]=="para"?Ad[Ad.length-1]:Ad;if(Ai&&Ad.length>1){Ab.unshift(Ai)}for(var Ae=0;Ae<Ab.length;Ae++){var Ag=Ab[Ae],Ac=typeof Ag=="string";if(Ac&&Ah.length>1&&typeof Ah[Ah.length-1]=="string"){Ah[Ah.length-1]+=Ag}else{Ah.push(Ag)}}}function v(Ac,Ab){var Af=new RegExp("^("+x+"{"+Ac+"}.*?\\n?)*$"),Ae=new RegExp("^"+x+"{"+Ac+"}","gm"),Ad=[];while(Ab.length>0){if(Af.exec(Ab[0])){var Ag=Ab.shift(),Ah=Ag.replace(Ae,"");Ad.push(H(Ah,Ag.trailing,Ag.lineNumber))}break}return Ad}function y(Ac,Ab,Af){var Ad=Ac.list;var Ae=Ad[Ad.length-1];if(Ae[1] instanceof Array&&Ae[1][0]=="para"){return}if(Ab+1==Af.length){Ae.push(["para"].concat(Ae.splice(1)))}else{var Ag=Ae.pop();Ae.push(["para"].concat(Ae.splice(1)),Ag)}}return function(Ad,Ae){var Ah=Ad.match(t);if(!Ah){return undefined}function An(Aw){var Ax=u.exec(Aw[2])?["bulletlist"]:["numberlist"];Am.push({list:Ax,indent:Aw[1]});return Ax}var Am=[],Ab=An(Ah),Ap,Ar=false,Au=[Am[0].list],Af;loose_search:while(true){var Al=Ad.split(/(?=\n)/);var Ac="";tight_search:for(var Av=0;Av<Al.length;Av++){var Ao="",Ag=Al[Av].replace(/^\n/,function(Aw){Ao=Aw;return""});var Ai=r(Am.length);Ah=Ag.match(Ai);if(Ah[1]!==undefined){if(Ac.length){z(Ap,Ar,this.processInline(Ac),Ao);Ar=false;Ac=""}Ah[1]=Aa(Ah[1]);var Ak=Math.floor(Ah[1].length/4)+1;if(Ak>Am.length){Ab=An(Ah);Ap.push(Ab);Ap=Ab[1]=["listitem"]}else{var Aj=false;for(Af=0;Af<Am.length;Af++){if(Am[Af].indent!=Ah[1]){continue}Ab=Am[Af].list;Am.splice(Af+1);Aj=true;break}if(!Aj){Ak++;if(Ak<=Am.length){Am.splice(Ak);Ab=Am[Ak-1].list}else{Ab=An(Ah);Ap.push(Ab)}}Ap=["listitem"];Ab.push(Ap)}Ao=""}if(Ag.length>Ah[0].length){Ac+=Ao+Ag.substr(Ah[0].length)}}if(Ac.length){z(Ap,Ar,this.processInline(Ac),Ao);Ar=false;Ac=""}var At=v(Am.length,Ae);if(At.length>0){W(Am,y,this);Ap.push.apply(Ap,this.toTree(At,[]))}var As=Ae[0]&&Ae[0].valueOf()||"";if(As.match(t)||As.match(/^ /)){Ad=Ae.shift();var Aq=this.dialect.block.horizRule(Ad,Ae);if(Aq){Au.push.apply(Au,Aq);break}W(Am,y,this);Ar=true;continue loose_search}break}return Au}})(),blockquote:function L(t,x){if(!t.match(/^>/m)){return undefined}var y=[];if(t[0]!=">"){var s=t.split(/\n/),r=[];while(s.length&&s[0][0]!=">"){r.push(s.shift())}t=s.join("\n");y.push.apply(y,this.processBlock(r.join("\n"),[]))}while(x.length&&x[0][0]==">"){var u=x.shift();t=new String(t+t.trailing+u);t.trailing=u.trailing}var v=t.replace(/^> ?/gm,""),w=this.tree;y.push(this.toTree(v,["blockquote"]));return y},referenceDefn:function O(v,s){var r=/^\s*\[(.*?)\]:\s*(\S+)(?:\s+(?:(['"])(.*?)\3|\((.*?)\)))?\n?/;if(!v.match(r)){return undefined}if(!E(this.tree)){this.tree.splice(1,0,{})}var t=E(this.tree);if(t.references===undefined){t.references={}}var u=this.loop_re_over_block(r,v,function(x){if(x[2]&&x[2][0]=="<"&&x[2][x[2].length-1]==">"){x[2]=x[2].substring(1,x[2].length-1)}var w=t.references[x[1].toLowerCase()]={href:x[2]};if(x[4]!==undefined){w.title=x[4]}else{if(x[5]!==undefined){w.title=x[5]}}});if(u.length){s.unshift(H(u,v.trailing))}return[]},para:function A(s,r){return[["para"].concat(this.processInline(s))]}}};F.dialects.Gruber.inline={__oneElement__:function N(u,v,t){var w,x,r=0;v=v||this.dialect.inline.__patterns__;var s=new RegExp("([\\s\\S]*?)("+(v.source||v)+")");w=s.exec(u);if(!w){return[u.length,u]}else{if(w[1]){return[w[1].length,w[1]]}}var x;if(w[2] in this.dialect.inline){x=this.dialect.inline[w[2]].call(this,u.substr(w.index),w,t||[])}x=x||[w[2].length,w[2]];return x},__call__:function j(s,v){var t=[],u;function r(w){if(typeof w=="string"&&typeof t[t.length-1]=="string"){t[t.length-1]+=w}else{t.push(w)}}while(s.length>0){u=this.dialect.inline.__oneElement__.call(this,s,v,t);s=s.substr(u.shift());W(u,r)}return t},"]":function(){},"}":function(){},"\\":function C(r){if(r.match(/^\\[\\`\*_{}\[\]()#\+.!\-]/)){return[2,r[1]]}else{return[1,"\\"]}},"![":function K(s){var t=s.match(/^!\[(.*?)\][ \t]*\([ \t]*(\S*)(?:[ \t]+(["'])(.*?)\3)?[ \t]*\)/);if(t){if(t[2]&&t[2][0]=="<"&&t[2][t[2].length-1]==">"){t[2]=t[2].substring(1,t[2].length-1)}t[2]=this.dialect.inline.__call__.call(this,t[2],/\\/)[0];var r={alt:t[1],href:t[2]||""};if(t[4]!==undefined){r.title=t[4]}return[t[0].length,["img",r]]}t=s.match(/^!\[(.*?)\][ \t]*\[(.*?)\]/);if(t){return[t[0].length,["img_ref",{alt:t[1],ref:t[2].toLowerCase(),original:t[0]}]]}return[2,"!["]},"[":function Y(w){var Ab=String(w);var z=F.DialectHelpers.inline_until_char.call(this,w.substr(1),"]");if(!z){return[1,"["]}var Aa=1+z[0],u=z[1],s,t;w=w.substr(Aa);var x=w.match(/^\s*\([ \t]*(\S+)(?:[ \t]+(["'])(.*?)\2)?[ \t]*\)/);if(x){var y=x[1];Aa+=x[0].length;if(y&&y[0]=="<"&&y[y.length-1]==">"){y=y.substring(1,y.length-1)}if(!x[3]){var v=1;for(var r=0;r<y.length;r++){switch(y[r]){case"(":v++;break;case")":if(--v==0){Aa-=y.length-r;y=y.substring(0,r)}break}}}y=this.dialect.inline.__call__.call(this,y,/\\/)[0];t={href:y||""};if(x[3]!==undefined){t.title=x[3]}s=["link",t].concat(u);return[Aa,s]}x=w.match(/^\s*\[(.*?)\]/);if(x){Aa+=x[0].length;t={ref:(x[1]||String(u)).toLowerCase(),original:Ab.substr(0,Aa)};s=["link_ref",t].concat(u);return[Aa,s]}if(u.length==1&&typeof u[0]=="string"){t={ref:u[0].toLowerCase(),original:Ab.substr(0,Aa)};s=["link_ref",t,u[0]];return[Aa,s]}return[1,"["]},"<":function q(r){var s;if((s=r.match(/^<(?:((https?|ftp|mailto):[^>]+)|(.*?@.*?\.[a-zA-Z]+))>/))!=null){if(s[3]){return[s[0].length,["link",{href:"mailto:"+s[3]},s[3]]]}else{if(s[2]=="mailto"){return[s[0].length,["link",{href:s[1]},s[1].substr("mailto:".length)]]}else{return[s[0].length,["link",{href:s[1]},s[1]]]}}}return[1,"<"]},"`":function G(r){var s=r.match(/(`+)(([\s\S]*?)\1)/);if(s&&s[2]){return[s[1].length+s[2].length,["inlinecode",s[3]]]}else{return[1,"`"]}},"  \n":function b(r){return[3,["linebreak"]]}};function J(r,s){var u=r+"_state",v=r=="strong"?"em_state":"strong_state";function t(w){this.len_after=w;this.name="close_"+s}return function(Aa,Ab){if(this[u][0]==s){this[u].shift();return[Aa.length,new t(Aa.length-s.length)]}else{var Ac=this[v].slice(),y=this[u].slice();this[u].unshift(s);var w=this.processInline(Aa.substr(s.length));var z=w[w.length-1];var x=this[u].shift();if(z instanceof t){w.pop();var Ad=Aa.length-z.len_after;return[Ad,[r].concat(w)]}else{this[v]=Ac;this[u]=y;return[s.length,s]}}}}F.dialects.Gruber.inline["**"]=J("strong","**");F.dialects.Gruber.inline["__"]=J("strong","__");F.dialects.Gruber.inline["*"]=J("em","*");F.dialects.Gruber.inline["_"]=J("em","_");F.buildBlockOrder=function(r){var t=[];for(var s in r){if(s=="__order__"||s=="__call__"){continue}t.push(s)}r.__order__=t};F.buildInlinePatterns=function(r){var v=[];for(var s in r){if(s.match(/^__.*__$/)){continue}var t=s.replace(/([\\.*+?|()\[\]{}])/g,"\\$1").replace(/\n/,"\\n");v.push(s.length==1?t:"(?:"+t+")")}v=v.join("|");r.__patterns__=v;var u=r.__call__;r.__call__=function(w,x){if(x!=undefined){return u.call(this,w,x)}else{return u.call(this,w,v)}}};F.DialectHelpers={};F.DialectHelpers.inline_until_char=function(r,u){var v=0,s=[];while(true){if(r[v]==u){v++;return[v,s]}if(v>=r.length){return null}var t=this.dialect.inline.__oneElement__.call(this,r.substr(v));v+=t[0];s.push.apply(s,t.slice(1))}};F.subclassDialect=function(s){function r(){}r.prototype=s.block;function t(){}t.prototype=s.inline;return{block:new r(),inline:new t()}};F.buildBlockOrder(F.dialects.Gruber.block);F.buildInlinePatterns(F.dialects.Gruber.inline);F.dialects.Maruku=F.subclassDialect(F.dialects.Gruber);F.dialects.Maruku.processMetaHash=function M(v){var u=D(v),w={};for(var r=0;r<u.length;++r){if(/^#/.test(u[r])){w.id=u[r].substring(1)}else{if(/^\./.test(u[r])){if(w["class"]){w["class"]=w["class"]+u[r].replace(/./," ")}else{w["class"]=u[r].substring(1)}}else{if(/\=/.test(u[r])){var t=u[r].split(/\=/);w[t[0]]=t[1]}}}}return w};function D(u){var s=u.split(""),r=[""],t=false;while(s.length){var v=s.shift();switch(v){case" ":if(t){r[r.length-1]+=v}else{r.push("")}break;case"'":case'"':t=!t;break;case"\\":v=s.shift();default:r[r.length-1]+=v;break}}return r}F.dialects.Maruku.block.document_meta=function c(w,s){if(w.lineNumber>1){return undefined}if(!w.match(/^(?:\w+:.*\n)*\w+:.*$/)){return undefined}if(!E(this.tree)){this.tree.splice(1,0,{})}var t=w.split(/\n/);for(p in t){var u=t[p].match(/(\w+):\s*(.*)$/),r=u[1].toLowerCase(),v=u[2];this.tree[1][r]=v}return[]};F.dialects.Maruku.block.block_meta=function d(t,x){var v=t.match(/(^|\n) {0,3}\{:\s*((?:\\\}|[^\}])*)\s*\}$/);if(!v){return undefined}var s=this.dialect.processMetaHash(v[2]);var y;if(v[1]===""){var u=this.tree[this.tree.length-1];y=E(u);if(typeof u==="string"){return undefined}if(!y){y={};u.splice(1,0,y)}for(a in s){y[a]=s[a]}return[]}var w=t.replace(/\n.*$/,""),r=this.processBlock(w,[]);y=E(r[0]);if(!y){y={};r[0].splice(1,0,y)}for(a in s){y[a]=s[a]}return r};F.dialects.Maruku.block.definition_list=function k(v,z){var r=/^((?:[^\s:].*\n)+):\s+([\s\S]+)$/,t=["dl"],u;if((w=v.match(r))){var Aa=[v];while(z.length&&r.exec(z[0])){Aa.push(z.shift())}for(var x=0;x<Aa.length;++x){var w=Aa[x].match(r),s=w[1].replace(/\n$/,"").split(/\n/),y=w[2].split(/\n:\s+/);for(u=0;u<s.length;++u){t.push(["dt",s[u]])}for(u=0;u<y.length;++u){t.push(["dd"].concat(this.processInline(y[u].replace(/(\n)\s+/,"$1"))))}}}else{return undefined}return[t]};F.dialects.Maruku.inline["{:"]=function n(v,w,r){if(!r.length){return[2,"{:"]}var y=r[r.length-1];if(typeof y==="string"){return[2,"{:"]}var x=v.match(/^\{:\s*((?:\\\}|[^\}])*)\s*\}/);if(!x){return[2,"{:"]}var s=this.dialect.processMetaHash(x[1]),t=E(y);if(!t){t={};y.splice(1,0,t)}for(var u in s){t[u]=s[u]}return[x[0].length,""]};F.buildBlockOrder(F.dialects.Maruku.block);F.buildInlinePatterns(F.dialects.Maruku.inline);var m=Array.isArray||function(r){return Object.prototype.toString.call(r)=="[object Array]"};var W;if(Array.prototype.forEach){W=function(t,r,s){return t.forEach(r,s)}}else{W=function(u,r,s){for(var t=0;t<u.length;t++){r.call(s||u,u[t],t,u)}}}function E(r){return m(r)&&r.length>1&&typeof r[1]==="object"&&!(m(r[1]))?r[1]:undefined}h.renderJsonML=function(r,s){s=s||{};s.root=s.root||false;var t=[];if(s.root){t.push(U(r))}else{r.shift();if(r.length&&typeof r[0]==="object"&&!(r[0] instanceof Array)){r.shift()}while(r.length){t.push(U(r.shift()))}}return t.join("\n\n")};function Z(r){return r.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function U(s){if(typeof s==="string"){return Z(s)}var r=s.shift(),t={},v=[];if(s.length&&typeof s[0]==="object"&&!(s[0] instanceof Array)){t=s.shift()}while(s.length){v.push(arguments.callee(s.shift()))}var u="";for(var w in t){u+=" "+w+'="'+Z(t[w])+'"'}if(r=="img"||r=="br"||r=="hr"){return"<"+r+u+"/>"}else{return"<"+r+u+">"+v.join("")+"</"+r+">"}}function I(y,w,v){var u;v=v||{};var z=y.slice(0);if(typeof v.preprocessTreeNode==="function"){z=v.preprocessTreeNode(z,w)}var r=E(z);if(r){z[1]={};for(u in r){z[1][u]=r[u]}r=z[1]}if(typeof z==="string"){return z}switch(z[0]){case"header":z[0]="h"+z[1].level;delete z[1].level;break;case"bulletlist":z[0]="ul";break;case"numberlist":z[0]="ol";break;case"listitem":z[0]="li";break;case"para":z[0]="p";break;case"markdown":z[0]="html";if(r){delete r.references}break;case"code_block":z[0]="pre";u=r?2:1;var t=["code"];t.push.apply(t,z.splice(u));z[u]=t;break;case"inlinecode":z[0]="code";break;case"img":z[1].src=z[1].href;delete z[1].href;break;case"linebreak":z[0]="br";break;case"link":z[0]="a";break;case"link_ref":z[0]="a";var s=w[r.ref];if(s){delete r.ref;r.href=s.href;if(s.title){r.title=s.title}delete r.original}else{return r.original}break;case"img_ref":z[0]="img";var s=w[r.ref];if(s){delete r.ref;r.src=s.href;if(s.title){r.title=s.title}delete r.original}else{return r.original}break}u=1;if(r){for(var x in z[1]){u=2}if(u===1){z.splice(u,1)}}for(;u<z.length;++u){z[u]=arguments.callee(z[u],w,v)}return z}function o(s){var r=E(s)?2:1;while(r<s.length){if(typeof s[r]==="string"){if(r+1<s.length&&typeof s[r+1]==="string"){s[r]+=s.splice(r+1,1)[0]}else{++r}}else{arguments.callee(s[r]);++r}}}})((function(){if(typeof exports==="undefined"){window.markdown={};return window.markdown}else{return exports}})());