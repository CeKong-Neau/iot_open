(function(A,B){if(typeof define==="function"&&define.amd){define("simditor",["jquery","simple-module","simple-uploader"],function(E,C,D){return(A.returnExportsGlobal=B(E,C,D))})}else{if(typeof exports==="object"){module.exports=B(require("jquery"),require("simple-module"),require("simple-uploader"))}else{A["Simditor"]=B(jQuery,SimpleModule,simple.uploader)}}}(this,function(V,L,Z){var H,B={}.hasOwnProperty,R=function(m,n){for(var l in n){if(B.call(n,l)){m[l]=n[l]}}function o(){this.constructor=m}o.prototype=n.prototype;m.prototype=new o();m.__super__=n.prototype;return m};H=(function(m){R(l,m);function l(){return l.__super__.constructor.apply(this,arguments)}l.className="Selection";l.prototype._init=function(){this.editor=this._module;return this.sel=document.getSelection()};l.prototype.clear=function(){var o;try{return this.sel.removeAllRanges()}catch(n){o=n}};l.prototype.getRange=function(){if(!this.editor.inputManager.focused||!this.sel.rangeCount){return null}return this.sel.getRangeAt(0)};l.prototype.selectRange=function(n){this.clear();this.sel.addRange(n);if(!this.editor.inputManager.focused&&(this.editor.util.browser.firefox||this.editor.util.browser.msie)){return this.editor.body.focus()}};l.prototype.rangeAtEndOf=function(p,r){var n,o,q;if(r==null){r=this.getRange()}if(!((r!=null)&&r.collapsed)){return}p=V(p)[0];n=r.endContainer;o=this.editor.util.getNodeLength(n);if(!(r.endOffset===o-1&&V(n).contents().last().is("br"))&&r.endOffset!==o){return false}if(p===n){return true}else{if(!V.contains(p,n)){return false}}q=true;V(n).parentsUntil(p).addBack().each((function(s){return function(t,u){var w,v;v=V(u).parent().contents().filter(function(){return !(this!==u&&this.nodeType===3&&!this.nodeValue)});w=v.last();if(!(w.get(0)===u||(w.is("br")&&w.prev().get(0)===u))){q=false;return false}}})(this));return q};l.prototype.rangeAtStartOf=function(o,q){var n,p;if(q==null){q=this.getRange()}if(!((q!=null)&&q.collapsed)){return}o=V(o)[0];p=q.startContainer;if(q.startOffset!==0){return false}if(o===p){return true}else{if(!V.contains(o,p)){return false}}n=true;V(p).parentsUntil(o).addBack().each((function(r){return function(s,t){var u;u=V(t).parent().contents().filter(function(){return !(this!==t&&this.nodeType===3&&!this.nodeValue)});if(u.first().get(0)!==t){return n=false}}})(this));return n};l.prototype.insertNode=function(n,o){if(o==null){o=this.getRange()}if(o==null){return}n=V(n)[0];o.insertNode(n);return this.setRangeAfter(n,o)};l.prototype.setRangeAfter=function(n,o){if(o==null){o=this.getRange()}if(o==null){return}n=V(n)[0];o.setEndAfter(n);o.collapse(false);return this.selectRange(o)};l.prototype.setRangeBefore=function(n,o){if(o==null){o=this.getRange()}if(o==null){return}n=V(n)[0];o.setEndBefore(n);o.collapse(false);return this.selectRange(o)};l.prototype.setRangeAtStartOf=function(n,o){if(o==null){o=this.getRange()}n=V(n).get(0);o.setEnd(n,0);o.collapse(false);return this.selectRange(o)};l.prototype.setRangeAtEndOf=function(q,t){var s,u,n,r,o,p;if(t==null){t=this.getRange()}u=V(q);q=u.get(0);if(u.is("pre")){n=u.contents();if(n.length>0){r=n.last();o=r.text();if(o.charAt(o.length-1)==="\n"){t.setEnd(r[0],this.editor.util.getNodeLength(r[0])-1)}else{t.setEnd(r[0],this.editor.util.getNodeLength(r[0]))}}else{t.setEnd(q,0)}}else{p=this.editor.util.getNodeLength(q);if(q.nodeType!==3&&p>0){s=V(q).contents().last();if(s.is("br")){p-=1}else{if(s[0].nodeType!==3&&this.editor.util.isEmptyNode(s)){s.append(this.editor.util.phBr);q=s[0];p=0}}}t.setEnd(q,p)}t.collapse(false);return this.selectRange(t)};l.prototype.deleteRangeContents=function(p){var n,o;if(p==null){p=this.getRange()}o=p.cloneRange();n=p.cloneRange();o.collapse(true);n.collapse(false);if(!p.collapsed&&this.rangeAtStartOf(this.editor.body,o)&&this.rangeAtEndOf(this.editor.body,n)){this.editor.body.empty();p.setStart(this.editor.body[0],0);p.collapse(true);this.selectRange(p)}else{p.deleteContents()}return p};l.prototype.breakBlockEl=function(n,p){var o;if(p==null){p=this.getRange()}o=V(n);if(!p.collapsed){return o}p.setStartBefore(o.get(0));if(p.collapsed){return o}return o.before(p.extractContents())};l.prototype.save=function(q){var o,n,p;if(q==null){q=this.getRange()}if(this._selectionSaved){return}n=q.cloneRange();n.collapse(false);p=V("<span/>").addClass("simditor-caret-start");o=V("<span/>").addClass("simditor-caret-end");n.insertNode(o[0]);q.insertNode(p[0]);this.clear();return this._selectionSaved=true};l.prototype.restore=function(){var q,r,n,t,s,o,p;if(!this._selectionSaved){return false}s=this.editor.body.find(".simditor-caret-start");q=this.editor.body.find(".simditor-caret-end");if(s.length&&q.length){o=s.parent();p=o.contents().index(s);r=q.parent();n=r.contents().index(q);if(o[0]===r[0]){n-=1}t=document.createRange();t.setStart(o.get(0),p);t.setEnd(r.get(0),n);s.remove();q.remove();this.selectRange(t)}else{s.remove();q.remove()}this._selectionSaved=false;return t};return l})(L);var E,B={}.hasOwnProperty,R=function(m,n){for(var l in n){if(B.call(n,l)){m[l]=n[l]}}function o(){this.constructor=m}o.prototype=n.prototype;m.prototype=new o();m.__super__=n.prototype;return m},T=[].indexOf||function(o){for(var m=0,n=this.length;m<n;m++){if(m in this&&this[m]===o){return m}}return -1};E=(function(m){R(l,m);function l(){return l.__super__.constructor.apply(this,arguments)}l.prototype._init=function(){this.editor=this._module;this._allowedTags=["br","a","img","b","strong","i","u","font","p","ul","ol","li","blockquote","pre","h1","h2","h3","h4","hr"];this._allowedAttributes={img:["src","alt","width","height","data-image-src","data-image-size","data-image-name","data-non-image"],a:["href","target"],font:["color"],pre:["data-lang","class"],p:["data-indent"],h1:["data-indent"],h2:["data-indent"],h3:["data-indent"],h4:["data-indent"]};return this.editor.body.on("click","a",(function(n){return function(o){return false}})(this))};l.prototype.decorate=function(n){if(n==null){n=this.editor.body}return this.editor.trigger("decorate",[n])};l.prototype.undecorate=function(n){if(n==null){n=this.editor.body.clone()}this.editor.trigger("undecorate",[n]);return V.trim(n.html())};l.prototype.autolink=function(y){var v,u,x,p,r,o,n,w,q,t,s;if(y==null){y=this.editor.body}p=[];u=function(z){return z.contents().each(function(Aa,Ab){var Ad,Ac;Ad=V(Ab);if(Ad.is("a")||Ad.closest("a, pre",y).length){return}if(Ad.contents().length){return u(Ad)}else{if((Ac=Ad.text())&&/https?:\/\/|www\./ig.test(Ac)){return p.push(Ad)}}})};u(y);o=/(https?:\/\/|www\.)[\w\-\.\?&=\/#%:,@\!\+]+/ig;for(t=0,s=p.length;t<s;t++){v=p[t];w=v.text();n=[];r=null;x=0;while((r=o.exec(w))!==null){n.push(document.createTextNode(w.substring(x,r.index)));x=o.lastIndex;q=/^(http(s)?:\/\/|\/)/.test(r[0])?r[0]:"http://"+r[0];n.push(V('<a href="'+q+'" rel="nofollow"></a>').text(r[0])[0])}n.push(document.createTextNode(w.substring(x)));v.replaceWith(V(n))}return y};l.prototype.format=function(x){var o,y,v,w,s,u,r,p,q,t;if(x==null){x=this.editor.body}if(x.is(":empty")){x.append("<p>"+this.editor.util.phBr+"</p>");return x}q=x.contents();for(s=0,r=q.length;s<r;s++){v=q[s];this.cleanNode(v,true)}t=x.contents();for(u=0,p=t.length;u<p;u++){w=t[u];o=V(w);if(o.is("br")){if(typeof y!=="undefined"&&y!==null){y=null}o.remove()}else{if(this.editor.util.isBlockNode(w)){if(o.is("li")){if(y&&y.is("ul, ol")){y.append(w)}else{y=V("<ul/>").insertBefore(w);y.append(w)}}else{y=null}}else{if(!y||y.is("ul, ol")){y=V("<p/>").insertBefore(w)}y.append(w)}}}return x};l.prototype.cleanNode=function(Ac,v){var Af,y,t,Aa,o,r,Ae,Ad,s,z,u,Ab,w,x,q,p,Ag;y=V(Ac);if(!(y.length>0)){return}if(y[0].nodeType===3){z=y.text().replace(/(\r\n|\n|\r)/gm,"");if(z){u=document.createTextNode(z);y.replaceWith(u)}else{y.remove()}return}Ae=y.contents();Ad=y.is('[class^="simditor-"]');if(y.is(this._allowedTags.join(","))||Ad){if(y.is("a")&&(Af=y.find("img")).length>0){y.replaceWith(Af);y=Af;Ae=null}if(y.is("img")&&y.hasClass("uploading")){y.remove()}if(!Ad){o=this._allowedAttributes[y[0].tagName.toLowerCase()];p=V.makeArray(y[0].attributes);for(Ab=0,x=p.length;Ab<x;Ab++){r=p[Ab];if(!((o!=null)&&(Ag=r.name,T.call(o,Ag)>=0))){y.removeAttr(r.name)}}}}else{if(y[0].nodeType===1&&!y.is(":empty")){if(y.is("div, article, dl, header, footer, tr")){y.append("<br/>");Ae.first().unwrap()}else{if(y.is("table")){t=V("<p/>");y.find("tr").each((function(n){return function(Ah,Ai){return t.append(V(Ai).text()+"<br/>")}})(this));y.replaceWith(t);Ae=null}else{if(y.is("thead, tfoot")){y.remove();Ae=null}else{if(y.is("th")){Aa=V("<td/>").append(y.contents());y.replaceWith(Aa)}else{Ae.first().unwrap()}}}}}else{y.remove();Ae=null}}if(v&&(Ae!=null)&&!y.is("pre")){for(w=0,q=Ae.length;w<q;w++){s=Ae[w];this.cleanNode(s,true)}}return null};l.prototype.clearHtml=function(n,r){var q,p,o;if(r==null){r=true}q=V("<div/>").append(n);p=q.contents();o="";p.each((function(s){return function(t,u){var v,w;if(u.nodeType===3){return o+=u.nodeValue}else{if(u.nodeType===1){v=V(u);w=v.contents();if(w.length>0){o+=s.clearHtml(w)}if(r&&t<p.length-1&&v.is("br, p, div, li, tr, pre, address, artticle, aside, dl, figcaption, footer, h1, h2, h3, h4, header")){return o+="\n"}}}}})(this));return o};l.prototype.beautify=function(n){var o;o=function(p){return !!(p.is("p")&&!p.text()&&p.children(":not(br)").length<1)};return n.each((function(p){return function(r,q){var s;s=V(q);if(s.is(':not(img, br, col, td, hr, [class^="simditor-"]):empty')){s.remove()}if(o(s)){s.remove()}return s.find(':not(img, br, col, td, hr, [class^="simditor-"]):empty').remove()}})(this))};return l})(L);var j,B={}.hasOwnProperty,R=function(m,n){for(var l in n){if(B.call(n,l)){m[l]=n[l]}}function o(){this.constructor=m}o.prototype=n.prototype;m.prototype=new o();m.__super__=n.prototype;return m},T=[].indexOf||function(o){for(var m=0,n=this.length;m<n;m++){if(m in this&&this[m]===o){return m}}return -1};j=(function(m){R(l,m);function l(){return l.__super__.constructor.apply(this,arguments)}l.prototype.opts={pasteImage:false};l.prototype._modifierKeys=[16,17,18,91,93,224];l.prototype._arrowKeys=[37,38,39,40];l.prototype._init=function(){var n;this.editor=this._module;if(this.opts.pasteImage&&typeof this.opts.pasteImage!=="string"){this.opts.pasteImage="inline"}this._keystrokeHandlers={};this._shortcuts={};this._pasteArea=V("<div/>").css({width:"1px",height:"1px",overflow:"hidden",position:"fixed",right:"0",bottom:"100px"}).attr({tabIndex:"-1",contentEditable:true}).addClass("simditor-paste-area").appendTo(this.editor.el);this._cleanPasteArea=V("<textarea/>").css({width:"1px",height:"1px",overflow:"hidden",position:"fixed",right:"0",bottom:"101px"}).attr({tabIndex:"-1"}).addClass("simditor-clean-paste-area").appendTo(this.editor.el);V(document).on("selectionchange.simditor"+this.editor.id,(function(o){return function(p){if(!o.focused){return}if(o._selectionTimer){clearTimeout(o._selectionTimer);o._selectionTimer=null}return o._selectionTimer=setTimeout(function(){return o.editor.trigger("selectionchanged")},50)}})(this));this.editor.on("valuechanged",(function(o){return function(){if(!o.editor.util.closestBlockEl()){if(!o.focused){return}o.editor.selection.save();o.editor.formatter.format();o.editor.selection.restore()}o.editor.body.find("hr, pre, .simditor-table").each(function(q,p){var s,r;s=V(p);if(s.parent().is("blockquote")||s.parent()[0]===o.editor.body[0]){r=false;if(s.next().length===0){V("<p/>").append(o.editor.util.phBr).insertAfter(s);r=true}if(s.prev().length===0){V("<p/>").append(o.editor.util.phBr).insertBefore(s);r=true}if(r){return setTimeout(function(){return o.editor.trigger("valuechanged")},10)}}});o.editor.body.find("pre:empty").append(o.editor.util.phBr);if(!o.editor.util.supportSelectionChange&&o.focused){return o.editor.trigger("selectionchanged")}}})(this));this.editor.on("selectionchanged",(function(o){return function(p){return o.editor.undoManager.update()}})(this));this.editor.body.on("keydown",V.proxy(this._onKeyDown,this)).on("keypress",V.proxy(this._onKeyPress,this)).on("keyup",V.proxy(this._onKeyUp,this)).on("mouseup",V.proxy(this._onMouseUp,this)).on("focus",V.proxy(this._onFocus,this)).on("blur",V.proxy(this._onBlur,this)).on("paste",V.proxy(this._onPaste,this)).on("drop",V.proxy(this._onDrop,this));if(this.editor.util.browser.firefox){this.addShortcut("cmd+37",(function(o){return function(p){p.preventDefault();o.editor.selection.sel.modify("move","backward","lineboundary");return false}})(this));this.addShortcut("cmd+39",(function(o){return function(p){p.preventDefault();o.editor.selection.sel.modify("move","forward","lineboundary");return false}})(this))}n=this.editor.util.os.mac?"cmd+13":"ctrl+13";this.addShortcut(n,(function(o){return function(p){o.editor.el.closest("form").find("button:submit").click();return false}})(this));if(this.editor.textarea.attr("autofocus")){return setTimeout((function(o){return function(){return o.editor.focus()}})(this),0)}};l.prototype._onFocus=function(n){this.editor.el.addClass("focus").removeClass("error");this.focused=true;this.lastCaretPosition=null;return setTimeout((function(o){return function(){o.editor.triggerHandler("focus");return o.editor.trigger("selectionchanged")}})(this),0)};l.prototype._onBlur=function(n){var o;this.editor.el.removeClass("focus");this.editor.sync();this.focused=false;this.lastCaretPosition=(o=this.editor.undoManager.currentState())!=null?o.caret:void 0;return this.editor.triggerHandler("blur")};l.prototype._onMouseUp=function(n){if(!this.editor.util.supportSelectionChange){return setTimeout((function(o){return function(){return o.editor.trigger("selectionchanged")}})(this),0)}};l.prototype._onKeyDown=function(n){var p,s,q,u,o,t,r;if(this.editor.triggerHandler(n)===false){return false}u=this.editor.util.getShortcutKey(n);if(this._shortcuts[u]){return this._shortcuts[u].call(this,n)}if(n.which in this._keystrokeHandlers){q=typeof(o=this._keystrokeHandlers[n.which])["*"]==="function"?o["*"](n):void 0;if(q){this.editor.trigger("valuechanged");return false}this.editor.util.traverseUp((function(v){return function(w){var y,x;if(w.nodeType!==1){return}y=(x=v._keystrokeHandlers[n.which])!=null?x[w.tagName.toLowerCase()]:void 0;q=typeof y==="function"?y(n,V(w)):void 0;if(q===true||q===false){return false}}})(this));if(q){this.editor.trigger("valuechanged");return false}}if((t=n.which,T.call(this._modifierKeys,t)>=0)||(r=n.which,T.call(this._arrowKeys,r)>=0)){return}s=this.editor.util.metaKey(n);p=this.editor.util.closestBlockEl();if(s&&n.which===86){return}if(this.editor.util.browser.webkit&&n.which===8&&this.editor.selection.rangeAtStartOf(p)){setTimeout((function(v){return function(){var w;w=v.editor.util.closestBlockEl();v.editor.selection.save();v.editor.formatter.cleanNode(w,true);v.editor.selection.restore();return v.editor.trigger("valuechanged")}})(this),10);this.typing=true}else{if(this._typing){if(this._typing!==true){clearTimeout(this._typing)}this._typing=setTimeout((function(v){return function(){v.editor.trigger("valuechanged");return v._typing=false}})(this),200)}else{setTimeout((function(v){return function(){return v.editor.trigger("valuechanged")}})(this),10);this._typing=true}}return null};l.prototype._onKeyPress=function(n){if(this.editor.triggerHandler(n)===false){return false}};l.prototype._onKeyUp=function(n){var o,q;if(this.editor.triggerHandler(n)===false){return false}if(!this.editor.util.supportSelectionChange&&(q=n.which,T.call(this._arrowKeys,q)>=0)){this.editor.trigger("selectionchanged");this.editor.undoManager.update();return}if((n.which===8||n.which===46)&&this.editor.util.isEmptyNode(this.editor.body)){this.editor.body.empty();o=V("<p/>").append(this.editor.util.phBr).appendTo(this.editor.body);this.editor.selection.setRangeAtStartOf(o)}};l.prototype._onPaste=function(n){var p,q,u,o,t,r,s;if(this.editor.triggerHandler(n)===false){return false}t=this.editor.selection.deleteRangeContents();if(!t.collapsed){t.collapse(true)}p=this.editor.util.closestBlockEl();q=p.is("pre, table");if(n.originalEvent.clipboardData&&n.originalEvent.clipboardData.items&&n.originalEvent.clipboardData.items.length>0){o=n.originalEvent.clipboardData.items[0];if(/^image\//.test(o.type)&&!q){u=o.getAsFile();if(!((u!=null)&&this.opts.pasteImage)){return}if(!u.name){u.name="Clipboard Image.png"}r={};r[this.opts.pasteImage]=true;if((s=this.editor.uploader)!=null){s.upload(u,r)}return false}}this.editor.selection.save(t);if(q){this._cleanPasteArea.focus();if(this.editor.util.browser.firefox){n.preventDefault();this._cleanPasteArea.val(n.originalEvent.clipboardData.getData("text/plain"))}else{if(this.editor.util.browser.msie&&this.editor.util.browser.version===10){n.preventDefault();this._cleanPasteArea.val(window.clipboardData.getData("Text"))}}}else{this._pasteArea.focus();if(this.editor.util.browser.msie&&this.editor.util.browser.version===10){n.preventDefault();this._pasteArea.html(window.clipboardData.getData("Text"))}}return setTimeout((function(v){return function(){var An,w,Af,x,Ak,Ai,Ah,Am,Al,Aa,Ad,Ao,Aj,Ae,z,y,Ab,Ac,Ag,Ap,Aq,Ar;if(v._pasteArea.is(":empty")&&!v._cleanPasteArea.val()){Al=null}else{if(q){Al=v._cleanPasteArea.val()}else{Al=V("<div/>").append(v._pasteArea.contents());v.editor.formatter.format(Al);v.editor.formatter.decorate(Al);v.editor.formatter.beautify(Al.children());Al=Al.contents()}}v._pasteArea.empty();v._cleanPasteArea.val("");t=v.editor.selection.restore();if(v.editor.triggerHandler("pasting",[Al])===false){return}if(!Al){return}else{if(q){if(p.is("table")){Ah=Al.split("\n");Ak=Ah.pop();for(Aa=0,Ae=Ah.length;Aa<Ae;Aa++){Ai=Ah[Aa];v.editor.selection.insertNode(document.createTextNode(Ai));v.editor.selection.insertNode(V("<br/>"))}v.editor.selection.insertNode(document.createTextNode(Ak))}else{Al=V("<div/>").text(Al);Ap=Al.contents();for(Ad=0,z=Ap.length;Ad<z;Ad++){Am=Ap[Ad];v.editor.selection.insertNode(V(Am)[0],t)}}}else{if(p.is(v.editor.body)){for(Ao=0,y=Al.length;Ao<y;Ao++){Am=Al[Ao];v.editor.selection.insertNode(Am,t)}}else{if(Al.length<1){return}else{if(Al.length===1){if(Al.is("p")){Af=Al.contents();if(Af.length===1&&Af.is("img")){An=Af;if(/^data:image/.test(An.attr("src"))){if(!v.opts.pasteImage){return}w=v.editor.util.dataURLtoBlob(An.attr("src"));w.name="Clipboard Image.png";r={};r[v.opts.pasteImage]=true;if((Aq=v.editor.uploader)!=null){Aq.upload(w,r)}return}else{if(An.is('img[src^="webkit-fake-url://"]')){return}}}else{for(Aj=0,Ab=Af.length;Aj<Ab;Aj++){Am=Af[Aj];v.editor.selection.insertNode(Am,t)}}}else{if(p.is("p")&&v.editor.util.isEmptyNode(p)){p.replaceWith(Al);v.editor.selection.setRangeAtEndOf(Al,t)}else{if(Al.is("ul, ol")){if(Al.find("li").length===1){Al=V("<div/>").text(Al.text());Ar=Al.contents();for(Ag=0,Ac=Ar.length;Ag<Ac;Ag++){Am=Ar[Ag];v.editor.selection.insertNode(V(Am)[0],t)}}else{if(p.is("li")){p.parent().after(Al);v.editor.selection.setRangeAtEndOf(Al,t)}else{p.after(Al);v.editor.selection.setRangeAtEndOf(Al,t)}}}else{p.after(Al);v.editor.selection.setRangeAtEndOf(Al,t)}}}}else{if(p.is("li")){p=p.parent()}if(v.editor.selection.rangeAtStartOf(p,t)){x="before"}else{if(v.editor.selection.rangeAtEndOf(p,t)){x="after"}else{v.editor.selection.breakBlockEl(p,t);x="before"}}p[x](Al);v.editor.selection.setRangeAtEndOf(Al.last(),t)}}}}}return v.editor.trigger("valuechanged")}})(this),10)};l.prototype._onDrop=function(n){if(this.editor.triggerHandler(n)===false){return false}return setTimeout((function(o){return function(){return o.editor.trigger("valuechanged")}})(this),0)};l.prototype.addKeystrokeHandler=function(n,o,p){if(!this._keystrokeHandlers[n]){this._keystrokeHandlers[n]={}}return this._keystrokeHandlers[n][o]=p};l.prototype.addShortcut=function(o,n){return this._shortcuts[o]=V.proxy(n,this)};return l})(L);var Y,B={}.hasOwnProperty,R=function(m,n){for(var l in n){if(B.call(n,l)){m[l]=n[l]}}function o(){this.constructor=m}o.prototype=n.prototype;m.prototype=new o();m.__super__=n.prototype;return m};Y=(function(l){R(m,l);function m(){return m.__super__.constructor.apply(this,arguments)}m.prototype._init=function(){var n;this.editor=this._module;if(this.editor.util.browser.safari){this.editor.inputManager.addKeystrokeHandler("13","*",(function(o){return function(p){var q;if(!p.shiftKey){return}q=V("<br/>");if(o.editor.selection.rangeAtEndOf($blockEl)){o.editor.selection.insertNode(q);o.editor.selection.insertNode(V("<br/>"));o.editor.selection.setRangeBefore(q)}else{o.editor.selection.insertNode(q)}return true}})(this))}if(this.editor.util.browser.webkit||this.editor.util.browser.msie){n=(function(o){return function(q,r){var p;if(!o.editor.selection.rangeAtEndOf(r)){return}p=V("<p/>").append(o.editor.util.phBr).insertAfter(r);o.editor.selection.setRangeAtStartOf(p);return true}})(this);this.editor.inputManager.addKeystrokeHandler("13","h1",n);this.editor.inputManager.addKeystrokeHandler("13","h2",n);this.editor.inputManager.addKeystrokeHandler("13","h3",n);this.editor.inputManager.addKeystrokeHandler("13","h4",n);this.editor.inputManager.addKeystrokeHandler("13","h5",n);this.editor.inputManager.addKeystrokeHandler("13","h6",n)}this.editor.inputManager.addKeystrokeHandler("8","*",(function(o){return function(p){var r,q;q=o.editor.util.furthestBlockEl();r=q.prev();if(r.is("hr")&&o.editor.selection.rangeAtStartOf(q)){o.editor.selection.save();r.remove();o.editor.selection.restore();return true}}})(this));this.editor.inputManager.addKeystrokeHandler("9","*",(function(o){return function(p){if(!o.editor.opts.tabIndent){return}if(p.shiftKey){o.editor.util.outdent()}else{o.editor.util.indent()}return true}})(this));this.editor.inputManager.addKeystrokeHandler("13","li",(function(o){return function(q,t){var r,p,s,u;r=t.clone();r.find("ul, ol").remove();if(!(o.editor.util.isEmptyNode(r)&&t.is(o.editor.util.closestBlockEl()))){return}p=t.parent();if(t.next("li").length>0){if(!o.editor.util.isEmptyNode(t)){return}if(p.parent("li").length>0){s=V("<li/>").append(o.editor.util.phBr).insertAfter(p.parent("li"));u=V("<"+p[0].tagName+"/>").append(t.nextAll("li"));s.append(u)}else{s=V("<p/>").append(o.editor.util.phBr).insertAfter(p);u=V("<"+p[0].tagName+"/>").append(t.nextAll("li"));s.after(u)}}else{if(p.parent("li").length>0){s=V("<li/>").insertAfter(p.parent("li"));if(t.contents().length>0){s.append(t.contents())}else{s.append(o.editor.util.phBr)}}else{s=V("<p/>").append(o.editor.util.phBr).insertAfter(p);if(t.children("ul, ol").length>0){s.after(t.children("ul, ol"))}}}if(t.prev("li").length){t.remove()}else{p.remove()}o.editor.selection.setRangeAtStartOf(s);return true}})(this));this.editor.inputManager.addKeystrokeHandler("13","pre",(function(o){return function(q,s){var p,r,t;q.preventDefault();if(q.shiftKey){p=V("<p/>").append(o.editor.util.phBr).insertAfter(s);o.editor.selection.setRangeAtStartOf(p);return true}t=o.editor.selection.getRange();r=null;t.deleteContents();if(!o.editor.util.browser.msie&&o.editor.selection.rangeAtEndOf(s)){r=document.createTextNode("\n\n");t.insertNode(r);t.setEnd(r,1)}else{r=document.createTextNode("\n");t.insertNode(r);t.setStartAfter(r)}t.collapse(false);o.editor.selection.selectRange(t);return true}})(this));this.editor.inputManager.addKeystrokeHandler("13","blockquote",(function(o){return function(p,r){var q;q=o.editor.util.closestBlockEl();if(!(q.is("p")&&!q.next().length&&o.editor.util.isEmptyNode(q))){return}r.after(q);o.editor.selection.setRangeAtStartOf(q);return true}})(this));this.editor.inputManager.addKeystrokeHandler("8","li",(function(o){return function(t,y){var p,q,v,s,u,w,x,r;q=y.children("ul, ol");u=y.prev("li");if(!(q.length>0&&u.length>0)){return false}r="";w=null;y.contents().each(function(z,Aa){if(Aa.nodeType===1&&/UL|OL/.test(Aa.nodeName)){return false}if(Aa.nodeType===1&&/BR/.test(Aa.nodeName)){return}if(Aa.nodeType===3&&Aa.nodeValue){r+=Aa.nodeValue}else{if(Aa.nodeType===1){r+=V(Aa).text()}}return w=V(Aa)});if(w&&r.length===1&&o.editor.util.browser.firefox&&!w.next("br").length){p=V(o.editor.util.phBr).insertAfter(w);w.remove();o.editor.selection.setRangeBefore(p);return true}else{if(r.length>0){return false}}x=document.createRange();s=u.children("ul, ol");if(s.length>0){v=V("<li/>").append(o.editor.util.phBr).appendTo(s);s.append(q.children("li"));y.remove();o.editor.selection.setRangeAtEndOf(v,x)}else{o.editor.selection.setRangeAtEndOf(u,x);u.append(q);y.remove();o.editor.selection.selectRange(x)}return true}})(this));this.editor.inputManager.addKeystrokeHandler("8","pre",(function(o){return function(q,s){var p,r;if(!o.editor.selection.rangeAtStartOf(s)){return}r=s.html().replace("\n","<br/>");p=V("<p/>").append(r||o.editor.util.phBr).insertAfter(s);s.remove();o.editor.selection.setRangeAtStartOf(p);return true}})(this));return this.editor.inputManager.addKeystrokeHandler("8","blockquote",(function(o){return function(p,q){var r;if(!o.editor.selection.rangeAtStartOf(q)){return}r=q.children().first().unwrap();o.editor.selection.setRangeAtStartOf(r);return true}})(this))};return m})(L);var c,B={}.hasOwnProperty,R=function(m,n){for(var l in n){if(B.call(n,l)){m[l]=n[l]}}function o(){this.constructor=m}o.prototype=n.prototype;m.prototype=new o();m.__super__=n.prototype;return m};c=(function(m){R(l,m);function l(){return l.__super__.constructor.apply(this,arguments)}l.className="UndoManager";l.prototype._index=-1;l.prototype._capacity=50;l.prototype._timer=null;l.prototype._init=function(){var o,n;this.editor=this._module;this._stack=[];if(this.editor.util.os.mac){n="cmd+90";o="shift+cmd+90"}else{if(this.editor.util.os.win){n="ctrl+90";o="ctrl+89"}else{n="ctrl+90";o="shift+ctrl+90"}}this.editor.inputManager.addShortcut(n,(function(p){return function(q){q.preventDefault();p.undo();return false}})(this));this.editor.inputManager.addShortcut(o,(function(p){return function(q){q.preventDefault();p.redo();return false}})(this));return this.editor.on("valuechanged",(function(p){return function(q,r){if(r==="undo"){return}if(p._timer){clearTimeout(p._timer);p._timer=null}return p._timer=setTimeout(function(){return p._pushUndoState()},200)}})(this))};l.prototype._pushUndoState=function(){var o,n;if(this.editor.triggerHandler("pushundostate")===false){return}o=this.currentState();n=this.editor.body.html();if(o&&o.html===n){return}this._index+=1;this._stack.length=this._index;this._stack.push({html:n,caret:this.caretPosition()});if(this._stack.length>this._capacity){this._stack.shift();return this._index-=1}};l.prototype.currentState=function(){if(this._stack.length&&this._index>-1){return this._stack[this._index]}else{return null}};l.prototype.undo=function(){var n;if(this._index<1||this._stack.length<2){return}this.editor.hidePopover();this._index-=1;n=this._stack[this._index];this.editor.body.html(n.html);this.caretPosition(n.caret);this.editor.body.find(".selected").removeClass("selected");this.editor.sync();return this.editor.trigger("valuechanged",["undo"])};l.prototype.redo=function(){var n;if(this._index<0||this._stack.length<this._index+2){return}this.editor.hidePopover();this._index+=1;n=this._stack[this._index];this.editor.body.html(n.html);this.caretPosition(n.caret);this.editor.body.find(".selected").removeClass("selected");this.editor.sync();return this.editor.trigger("valuechanged",["undo"])};l.prototype.update=function(){var o,n;if(this._timer){return}o=this.currentState();if(!o){return}n=this.editor.body.html();o.html=n;return o.caret=this.caretPosition()};l.prototype._getNodeOffset=function(q,r){var n,o,p;if(r){n=V(q)}else{n=V(q).parent()}p=0;o=false;n.contents().each((function(s){return function(t,u){if(r===t||q===u){return false}if(u.nodeType===3){if(!o){p+=1;o=true}}else{p+=1;o=false}return null}})(this));return p};l.prototype._getNodePosition=function(p,n){var q,o;if(p.nodeType===3){o=p.previousSibling;while(o&&o.nodeType===3){p=o;n+=this.editor.util.getNodeLength(o);o=o.previousSibling}}else{n=this._getNodeOffset(p,n)}q=[];q.unshift(n);this.editor.util.traverseUp((function(r){return function(s){return q.unshift(r._getNodeOffset(s))}})(this),p);return q};l.prototype._getNodeByPosition=function(t){var u,o,r,s,n,q,p,v;s=this.editor.body[0];v=t.slice(0,t.length-1);for(r=q=0,p=v.length;q<p;r=++q){n=v[r];o=s.childNodes;if(n>o.length-1){if(r===t.length-2&&V(s).is("pre")){u=document.createTextNode("");s.appendChild(u);o=s.childNodes}else{s=null;break}}s=o[n]}return s};l.prototype.caretPosition=function(q){var r,n,s,o,p;if(!q){s=this.editor.selection.getRange();if(!(this.editor.inputManager.focused&&(s!=null))){return{}}q={start:[],end:null,collapsed:true};q.start=this._getNodePosition(s.startContainer,s.startOffset);if(!s.collapsed){q.end=this._getNodePosition(s.endContainer,s.endOffset);q.collapsed=false}return q}else{if(!this.editor.inputManager.focused){this.editor.body.focus()}if(!q.start){this.editor.body.blur();return}o=this._getNodeByPosition(q.start);p=q.start[q.start.length-1];if(q.collapsed){r=o;n=p}else{r=this._getNodeByPosition(q.end);n=q.start[q.start.length-1]}if(!o||!r){throw new Error("simditor: invalid caret state");return}s=document.createRange();s.setStart(o,p);s.setEnd(r,n);return this.editor.selection.selectRange(s)}};return l})(L);var K,B={}.hasOwnProperty,R=function(m,n){for(var l in n){if(B.call(n,l)){m[l]=n[l]}}function o(){this.constructor=m}o.prototype=n.prototype;m.prototype=new o();m.__super__=n.prototype;return m};K=(function(m){R(l,m);function l(){return l.__super__.constructor.apply(this,arguments)}l.className="Util";l.prototype._init=function(){this.editor=this._module;if(this.browser.msie&&this.browser.version<11){return this.phBr=""}};l.prototype.phBr="<br/>";l.prototype.os=(function(){var n;n={};if(/Mac/.test(navigator.appVersion)){n.mac=true}else{if(/Linux/.test(navigator.appVersion)){n.linux=true}else{if(/Win/.test(navigator.appVersion)){n.win=true}else{if(/X11/.test(navigator.appVersion)){n.unix=true}}}}if(/Mobi/.test(navigator.appVersion)){n.mobile=true}return n})();l.prototype.browser=(function(){var o,p,n,q,r;r=navigator.userAgent;n=/(msie|trident)/i.test(r);o=/chrome|crios/i.test(r);q=/safari/i.test(r)&&!o;p=/firefox/i.test(r);if(n){return{msie:true,version:r.match(/(msie |rv:)(\d+(\.\d+)?)/i)[2]*1}}else{if(o){return{webkit:true,chrome:true,version:r.match(/(?:chrome|crios)\/(\d+(\.\d+)?)/i)[1]*1}}else{if(q){return{webkit:true,safari:true,version:r.match(/version\/(\d+(\.\d+)?)/i)[1]*1}}else{if(p){return{mozilla:true,firefox:true,version:r.match(/firefox\/(\d+(\.\d+)?)/i)[1]*1}}else{return{}}}}}})();l.prototype.supportSelectionChange=(function(){var o,p;p=document.onselectionchange;if(p!==void 0){try{document.onselectionchange=0;return document.onselectionchange===null}catch(n){o=n}finally{document.onselectionchange=p}}return false})();l.prototype.reflow=function(n){if(n==null){n=document}return V(n)[0].offsetHeight};l.prototype.metaKey=function(o){var n;n=/Mac/.test(navigator.userAgent);if(n){return o.metaKey}else{return o.ctrlKey}};l.prototype.isEmptyNode=function(n){var o;o=V(n);return o.is(":empty")||(!o.text()&&!o.find(":not(br, span, div)").length)};l.prototype.isBlockNode=function(n){n=V(n)[0];if(!n||n.nodeType===3){return false}return/^(div|p|ul|ol|li|blockquote|hr|pre|h1|h2|h3|h4|table)$/.test(n.nodeName.toLowerCase())};l.prototype.closestBlockEl=function(o){var p,n,q;if(o==null){q=this.editor.selection.getRange();o=q!=null?q.commonAncestorContainer:void 0}p=V(o);if(!p.length){return null}n=p.parentsUntil(this.editor.body).addBack();n=n.filter((function(r){return function(s){return r.isBlockNode(n.eq(s))}})(this));if(n.length){return n.last()}else{return null}};l.prototype.furthestNode=function(o,p){var q,n,r;if(o==null){r=this.editor.selection.getRange();o=r!=null?r.commonAncestorContainer:void 0}q=V(o);if(!q.length){return null}n=q.parentsUntil(this.editor.body).addBack();n=n.filter((function(s){return function(t){var u;u=n.eq(t);if(V.isFunction(p)){return p(u)}else{return u.is(p)}}})(this));if(n.length){return n.first()}else{return null}};l.prototype.furthestBlockEl=function(n){return this.furthestNode(n,this.isBlockNode)};l.prototype.getNodeLength=function(n){switch(n.nodeType){case 7:case 10:return 0;case 3:case 8:return n.length;default:return n.childNodes.length}};l.prototype.traverseUp=function(p,t){var s,w,v,o,r,q,u;if(t==null){v=this.editor.selection.getRange();t=v!=null?v.commonAncestorContainer:void 0}if((t==null)||!V.contains(this.editor.body[0],t)){return false}w=V(t).parentsUntil(this.editor.body).get();w.unshift(t);u=[];for(r=0,q=w.length;r<q;r++){s=w[r];o=p(s);if(o===false){break}else{u.push(void 0)}}return u};l.prototype.getShortcutKey=function(n){var o;o=[];if(n.shiftKey){o.push("shift")}if(n.ctrlKey){o.push("ctrl")}if(n.altKey){o.push("alt")}if(n.metaKey){o.push("cmd")}o.push(n.which);return o.join("+")};l.prototype.indent=function(){var p,n,q,r,o,s,u,t,v,w;p=this.editor.util.closestBlockEl();if(!(p&&p.length>0)){return false}if(p.is("pre")){t=document.createTextNode("\u00A0\u00A0");this.editor.selection.insertNode(t)}else{if(p.is("li")){r=p.prev("li");if(r.length<1){return false}this.editor.selection.save();v=p.parent()[0].tagName;n=r.children("ul, ol");if(n.length>0){n.append(p)}else{V("<"+v+"/>").append(p).appendTo(r)}this.editor.selection.restore()}else{if(p.is("p, h1, h2, h3, h4")){s=(w=p.attr("data-indent"))!=null?w:0;s=s*1+1;if(s>10){s=10}p.attr("data-indent",s)}else{if(p.is("table")){u=this.editor.selection.getRange();o=V(u.commonAncestorContainer).closest("td");q=o.next("td");if(!(q.length>0)){q=o.parent("tr").next("tr").find("td:first")}if(!(o.length>0&&q.length>0)){return false}this.editor.selection.setRangeAtEndOf(q)}else{t=document.createTextNode("\u00A0\u00A0\u00A0\u00A0");this.editor.selection.insertNode(t)}}}}this.editor.trigger("valuechanged");return true};l.prototype.outdent=function(){var p,n,r,u,o,q,s,t,v;p=this.editor.util.closestBlockEl();if(!(p&&p.length>0)){return false}if(p.is("pre")){return false}else{if(p.is("li")){n=p.parent();r=n.parent("li");if(r.length<1){q=this.editor.toolbar.findButton(n[0].tagName.toLowerCase());if(q!=null){q.command()}return false}this.editor.selection.save();if(p.next("li").length>0){V("<"+n[0].tagName+"/>").append(p.nextAll("li")).appendTo(p)}p.insertAfter(r);if(n.children("li").length<1){n.remove()}this.editor.selection.restore()}else{if(p.is("p, h1, h2, h3, h4")){s=(v=p.attr("data-indent"))!=null?v:0;s=s*1-1;if(s<0){s=0}p.attr("data-indent",s)}else{if(p.is("table")){t=this.editor.selection.getRange();o=V(t.commonAncestorContainer).closest("td");u=o.prev("td");if(!(u.length>0)){u=o.parent("tr").prev("tr").find("td:last")}if(!(o.length>0&&u.length>0)){return false}this.editor.selection.setRangeAtEndOf(u)}else{return false}}}}this.editor.trigger("valuechanged");return true};l.prototype.dataURLtoBlob=function(n){var x,w,o,y,u,r,t,s,v,q,p;r=window.Blob&&(function(){var Aa;try{return Boolean(new Blob())}catch(z){Aa=z;return false}})();u=r&&window.Uint8Array&&(function(){var Aa;try{return new Blob([new Uint8Array(100)]).size===100}catch(z){Aa=z;return false}})();x=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder;if(!((r||x)&&window.atob&&window.ArrayBuffer&&window.Uint8Array)){return false}if(n.split(",")[0].indexOf("base64")>=0){y=atob(n.split(",")[1])}else{y=decodeURIComponent(n.split(",")[1])}w=new ArrayBuffer(y.length);s=new Uint8Array(w);for(t=q=0,p=y.length;0<=p?q<=p:q>=p;t=0<=p?++q:--q){s[t]=y.charCodeAt(t)}v=n.split(",")[0].split(":")[1].split(";")[0];if(r){return new Blob([u?s:w],{type:v})}o=new x();o.append(w);return o.getBlob(v)};return l})(L);var W,B={}.hasOwnProperty,R=function(m,n){for(var l in n){if(B.call(n,l)){m[l]=n[l]}}function o(){this.constructor=m}o.prototype=n.prototype;m.prototype=new o();m.__super__=n.prototype;return m};W=(function(l){R(m,l);function m(){return m.__super__.constructor.apply(this,arguments)}m.className="Toolbar";m.prototype.opts={toolbar:true,toolbarFloat:true,toolbarHidden:false};m.prototype._tpl={wrapper:'<div class="simditor-toolbar"><ul></ul></div>',separator:'<li><span class="separator"></span></li>'};m.prototype._init=function(){var n;this.editor=this._module;if(!this.opts.toolbar){return}if(!V.isArray(this.opts.toolbar)){this.opts.toolbar=["bold","italic","underline","strikethrough","|","ol","ul","blockquote","code","|","link","image","|","indent","outdent"]}this._render();this.list.on("click",(function(o){return function(p){return false}})(this));this.wrapper.on("mousedown",(function(o){return function(p){return o.list.find(".menu-on").removeClass(".menu-on")}})(this));V(document).on("mousedown.simditor"+this.editor.id,(function(o){return function(p){return o.list.find(".menu-on").removeClass(".menu-on")}})(this));if(!this.opts.toolbarHidden&&this.opts.toolbarFloat){this.wrapper.width(this.wrapper.outerWidth());n=this.wrapper.outerHeight();if(!this.editor.util.os.mobile){V(window).on("resize.simditor-"+this.editor.id,(function(o){return function(p){o.wrapper.css("position","static");o.editor.util.reflow(o.wrapper);o.wrapper.css("left",o.wrapper.offset().left);return o.wrapper.css("position","")}})(this)).resize()}V(window).on("scroll.simditor-"+this.editor.id,(function(o){return function(p){var r,q,s;s=o.editor.wrapper.offset().top;r=s+o.editor.wrapper.outerHeight()-80;q=V(document).scrollTop();if(q<=s||q>=r){o.editor.wrapper.removeClass("toolbar-floating").css("padding-top","");if(o.editor.util.os.mobile){return o.wrapper.css({top:"auto"})}}else{o.editor.wrapper.addClass("toolbar-floating").css("padding-top",n);if(o.editor.util.os.mobile){return o.wrapper.css({top:q-s})}}}})(this))}this.editor.on("selectionchanged",(function(o){return function(){return o.toolbarStatus()}})(this));this.editor.on("destroy",(function(o){return function(){return o.buttons.length=0}})(this));return V(document).on("mousedown.simditor-"+this.editor.id,(function(o){return function(p){return o.list.find("li.menu-on").removeClass("menu-on")}})(this))};m.prototype._render=function(){var p,n,q,o;this.buttons=[];this.wrapper=V(this._tpl.wrapper).prependTo(this.editor.wrapper);this.list=this.wrapper.find("ul");o=this.opts.toolbar;for(n=0,q=o.length;n<q;n++){p=o[n];if(p==="|"){V(this._tpl.separator).appendTo(this.list);continue}if(!this.constructor.buttons[p]){throw new Error('simditor: invalid toolbar button "'+p+'"');continue}this.buttons.push(new this.constructor.buttons[p]({editor:this.editor}))}if(this.opts.toolbarHidden){return this.wrapper.hide()}else{return this.editor.placeholderEl.css("top",this.wrapper.outerHeight())}};m.prototype.toolbarStatus=function(n){var o;if(!this.editor.inputManager.focused){return}o=this.buttons.slice(0);return this.editor.util.traverseUp((function(p){return function(v){var w,u,x,s,t,r,q;x=[];for(u=s=0,r=o.length;s<r;u=++s){w=o[u];if((n!=null)&&w.name!==n){continue}if(!w.status||w.status(V(v))===true){x.push(w)}}for(t=0,q=x.length;t<q;t++){w=x[t];u=V.inArray(w,o);o.splice(u,1)}if(o.length===0){return false}}})(this))};m.prototype.findButton=function(o){var n;n=this.list.find(".toolbar-item-"+o).data("button");return n!=null?n:null};m.addButton=function(n){return this.buttons[n.prototype.name]=n};m.buttons={};return m})(L);var X,B={}.hasOwnProperty,R=function(m,n){for(var l in n){if(B.call(n,l)){m[l]=n[l]}}function o(){this.constructor=m}o.prototype=n.prototype;m.prototype=new o();m.__super__=n.prototype;return m};X=(function(l){R(m,l);function m(){return m.__super__.constructor.apply(this,arguments)}m.connect(K);m.connect(j);m.connect(c);m.connect(Y);m.connect(E);m.connect(H);m.connect(W);m.count=0;m.prototype.opts={textarea:null,placeholder:"",defaultImage:"images/image.png",params:{},upload:false,tabIndent:true};m.prototype._init=function(){var p,o,n;this.textarea=V(this.opts.textarea);this.opts.placeholder=this.opts.placeholder||this.textarea.attr("placeholder");if(!this.textarea.length){throw new Error("simditor: param textarea is required.");return}p=this.textarea.data("simditor");if(p!=null){p.destroy()}this.id=++m.count;this._render();if(this.opts.upload&&Z){n=typeof this.opts.upload==="object"?this.opts.upload:{};this.uploader=Z(n)}o=this.textarea.closest("form");if(o.length){o.on("submit.simditor-"+this.id,(function(q){return function(){return q.sync()}})(this));o.on("reset.simditor-"+this.id,(function(q){return function(){return q.setValue("")}})(this))}this.on("initialized",(function(q){return function(){if(q.opts.placeholder){q.on("valuechanged",function(){return q._placeholder()})}return q.setValue(q.textarea.val()||"")}})(this));if(this.util.browser.mozilla){document.execCommand("enableObjectResizing",false,false);return document.execCommand("enableInlineTableEditing",false,false)}};m.prototype._tpl='<div class="simditor">\n  <div class="simditor-wrapper">\n    <div class="simditor-placeholder"></div>\n    <div class="simditor-body" contenteditable="true">\n    </div>\n  </div>\n</div>';m.prototype._render=function(){var n,p,o,q;this.el=V(this._tpl).insertBefore(this.textarea);this.wrapper=this.el.find(".simditor-wrapper");this.body=this.wrapper.find(".simditor-body");this.placeholderEl=this.wrapper.find(".simditor-placeholder").append(this.opts.placeholder);this.el.append(this.textarea).data("simditor",this);this.textarea.data("simditor",this).hide().blur();this.body.attr("tabindex",this.textarea.attr("tabindex"));if(this.util.os.mac){this.el.addClass("simditor-mac")}else{if(this.util.os.linux){this.el.addClass("simditor-linux")}}if(this.util.os.mobile){this.el.addClass("simditor-mobile")}if(this.opts.params){o=this.opts.params;q=[];for(n in o){p=o[n];q.push(V("<input/>",{type:"hidden",name:n,value:p}).insertAfter(this.textarea))}return q}};m.prototype._placeholder=function(){var o,n;o=this.body.children();if(o.length===0||(o.length===1&&this.util.isEmptyNode(o)&&((n=o.data("indent"))!=null?n:0)<1)){return this.placeholderEl.show()}else{return this.placeholderEl.hide()}};m.prototype.setValue=function(n){this.hidePopover();this.textarea.val(n);this.body.html(n);this.formatter.format();this.formatter.decorate();return setTimeout((function(o){return function(){return o.trigger("valuechanged")}})(this),0)};m.prototype.getValue=function(){return this.sync()};m.prototype.sync=function(){var s,o,n,q,r,p;this.hidePopover;o=this.body.clone();this.formatter.undecorate(o);this.formatter.format(o);this.formatter.autolink(o);s=o.children();r=s.last("p");q=s.first("p");while(r.is("p")&&this.util.isEmptyNode(r)){n=r;r=r.prev("p");n.remove()}while(q.is("p")&&this.util.isEmptyNode(q)){n=q;q=r.next("p");n.remove()}o.find("img.uploading").remove();p=V.trim(o.html());this.textarea.val(p);return p};m.prototype.focus=function(){var n,o;if(this.inputManager.lastCaretPosition){return this.undoManager.caretPosition(this.inputManager.lastCaretPosition)}else{n=this.body.find("p, li, pre, h1, h2, h3, h4, td").first();if(!(n.length>0)){return}o=document.createRange();this.selection.setRangeAtStartOf(n,o);return this.body.focus()}};m.prototype.blur=function(){return this.body.blur()};m.prototype.hidePopover=function(){return this.el.find(".simditor-popover").each((function(n){return function(o,p){p=V(p).data("popover");if(p.active){return p.hide()}}})(this))};m.prototype.destroy=function(){this.triggerHandler("destroy");this.textarea.closest("form").off(".simditor .simditor-"+this.id);this.selection.clear();this.textarea.insertBefore(this.el).hide().val("").removeData("simditor");this.el.remove();V(document).off(".simditor-"+this.id);V(window).off(".simditor-"+this.id);return this.off()};return m})(L);X.i18n={"zh-CN":{"blockquote":"引用","bold":"加粗文字","code":"插入代码","color":"文字颜色","hr":"分隔线","insertImage":"插入图片","localImage":"本地图片","externalImage":"外链图片","uploadImage":"上传图片","uploadFailed":"上传失败了","uploadError":"上传出错了","imageUrl":"图片地址","imageSize":"图片尺寸","restoreImageSize":"还原图片尺寸","uploading":"正在上传","indent":"向右缩进","outdent":"向左缩进","italic":"斜体文字","insertLink":"插入链接","text":"文本","linkText":"链接文字","linkUrl":"地址","removeLink":"移除链接","ol":"有序列表","ul":"无序列表","strikethrough":"删除线文字","table":"表格","deleteRow":"删除行","insertRowAbove":"在上面插入行","insertRowBelow":"在下面插入行","deleteColumn":"删除列","insertColumnLeft":"在左边插入列","insertColumnRight":"在右边插入列","deleteTable":"删除表格","title":"标题","normalText":"普通文本","underline":"下划线文字"}};var N,B={}.hasOwnProperty,R=function(m,n){for(var l in n){if(B.call(n,l)){m[l]=n[l]}}function o(){this.constructor=m}o.prototype=n.prototype;m.prototype=new o();m.__super__=n.prototype;return m};N=(function(m){R(l,m);l.prototype._tpl={item:'<li><a tabindex="-1" unselectable="on" class="toolbar-item" href="javascript:;"><span></span></a></li>',menuWrapper:'<div class="toolbar-menu"></div>',menuItem:'<li><a tabindex="-1" unselectable="on" class="menu-item" href="javascript:;"><span></span></a></li>',separator:'<li><span class="separator"></span></li>'};l.prototype.name="";l.prototype.icon="";l.prototype.title="";l.prototype.text="";l.prototype.htmlTag="";l.prototype.disableTag="";l.prototype.menu=false;l.prototype.active=false;l.prototype.disabled=false;l.prototype.needFocus=true;l.prototype.shortcut=null;function l(n){this.editor=n.editor;l.__super__.constructor.call(this,n)}l.prototype._init=function(){var n,o,r,p,q;this.render();this.el.on("mousedown",(function(s){return function(t){var u,v;t.preventDefault();if(s.el.hasClass("disabled")||(s.needFocus&&!s.editor.inputManager.focused)){return false}if(s.menu){s.wrapper.toggleClass("menu-on").siblings("li").removeClass("menu-on");if(s.wrapper.is(".menu-on")){u=s.menuWrapper.offset().left+s.menuWrapper.outerWidth()+5-s.editor.wrapper.offset().left-s.editor.wrapper.outerWidth();if(u>0){s.menuWrapper.css({"left":"auto","right":0})}s.trigger("menuexpand")}return false}v=s.el.data("param");s.command(v);return false}})(this));this.wrapper.on("click","a.menu-item",(function(s){return function(t){var v,u;t.preventDefault();v=V(t.currentTarget);s.wrapper.removeClass("menu-on");if(v.hasClass("disabled")||(s.needFocus&&!s.editor.inputManager.focused)){return false}s.editor.toolbar.wrapper.removeClass("menu-on");u=v.data("param");s.command(u);return false}})(this));this.wrapper.on("mousedown","a.menu-item",(function(s){return function(t){return false}})(this));this.editor.on("blur",(function(s){return function(){s.setActive(false);return s.setDisabled(false)}})(this));if(this.shortcut!=null){this.editor.inputManager.addShortcut(this.shortcut,(function(s){return function(t){s.el.mousedown();return false}})(this))}p=this.htmlTag.split(",");q=[];for(o=0,r=p.length;o<r;o++){n=p[o];n=V.trim(n);if(n&&V.inArray(n,this.editor.formatter._allowedTags)<0){q.push(this.editor.formatter._allowedTags.push(n))}else{q.push(void 0)}}return q};l.prototype.render=function(){this.wrapper=V(this._tpl.item).appendTo(this.editor.toolbar.list);this.el=this.wrapper.find("a.toolbar-item");this.el.attr("title",this.title).addClass("toolbar-item-"+this.name).data("button",this);this.el.find("span").addClass(this.icon?"fa fa-"+this.icon:"").text(this.text);if(!this.menu){return}this.menuWrapper=V(this._tpl.menuWrapper).appendTo(this.wrapper);this.menuWrapper.addClass("toolbar-menu-"+this.name);return this.renderMenu()};l.prototype.renderMenu=function(){var n,s,t,q,p,o,r,u;if(!V.isArray(this.menu)){return}this.menuEl=V("<ul/>").appendTo(this.menuWrapper);o=this.menu;u=[];for(q=0,p=o.length;q<p;q++){t=o[q];if(t==="|"){V(this._tpl.separator).appendTo(this.menuEl);continue}s=V(this._tpl.menuItem).appendTo(this.menuEl);u.push(n=s.find("a.menu-item").attr({"title":(r=t.title)!=null?r:t.text,"data-param":t.param}).addClass("menu-item-"+t.name).find("span").text(t.text))}return u};l.prototype.setActive=function(n){if(n===this.active){return}this.active=n;this.el.toggleClass("active",this.active);return this.editor.toolbar.trigger("buttonstatus",[this])};l.prototype.setDisabled=function(n){if(n===this.disabled){return}this.disabled=n;this.el.toggleClass("disabled",this.disabled);return this.editor.toolbar.trigger("buttonstatus",[this])};l.prototype.status=function(n){if(n!=null){this.setDisabled(n.is(this.disableTag))}if(this.disabled){return true}if(n!=null){this.setActive(n.is(this.htmlTag))}return this.active};l.prototype.command=function(n){};return l})(L);X.Button=N;var I,B={}.hasOwnProperty,R=function(m,n){for(var l in n){if(B.call(n,l)){m[l]=n[l]}}function o(){this.constructor=m}o.prototype=n.prototype;m.prototype=new o();m.__super__=n.prototype;return m};I=(function(m){R(l,m);l.prototype.offset={top:4,left:0};l.prototype.target=null;l.prototype.active=false;function l(n){this.button=n.button;this.editor=n.button.editor;l.__super__.constructor.call(this,n)}l.prototype._init=function(){this.el=V('<div class="simditor-popover"></div>').appendTo(this.editor.el).data("popover",this);this.render();this.el.on("mouseenter",(function(n){return function(o){return n.el.addClass("hover")}})(this));return this.el.on("mouseleave",(function(n){return function(o){return n.el.removeClass("hover")}})(this))};l.prototype.render=function(){};l.prototype.show=function(o,n){if(n==null){n="bottom"}if(o==null){return}this.editor.hidePopover();this.target=o.addClass("selected");if(this.active){this.refresh(n);return this.trigger("popovershow")}else{this.active=true;this.el.css({left:-9999}).show();return setTimeout((function(p){return function(){p.refresh(n);return p.trigger("popovershow")}})(this),0)}};l.prototype.hide=function(){if(!this.active){return}if(this.target){this.target.removeClass("selected")}this.target=null;this.active=false;this.el.hide();return this.trigger("popoverhide")};l.prototype.refresh=function(q){var s,o,r,n,p;if(q==null){q="bottom"}if(!this.active){return}s=this.editor.el.offset();n=this.target.offset();r=this.target.outerHeight();if(q==="bottom"){p=n.top-s.top+r}else{if(q==="top"){p=n.top-s.top-this.el.height()}}o=Math.min(n.left-s.left,this.editor.wrapper.width()-this.el.outerWidth()-10);return this.el.css({top:p+this.offset.top,left:o+this.offset.left})};l.prototype.destroy=function(){this.target=null;this.active=false;this.editor.off(".linkpopover");return this.el.remove()};return l})(L);X.Popover=I;var P,B={}.hasOwnProperty,R=function(m,n){for(var l in n){if(B.call(n,l)){m[l]=n[l]}}function o(){this.constructor=m}o.prototype=n.prototype;m.prototype=new o();m.__super__=n.prototype;return m};P=(function(l){R(m,l);function m(){return m.__super__.constructor.apply(this,arguments)}m.prototype.name="title";m.prototype.title=X._t("title");m.prototype.htmlTag="h1, h2, h3, h4";m.prototype.disableTag="pre, table";m.prototype.menu=[{name:"normal",text:X._t("normalText"),param:"p"},"|",{name:"h1",text:X._t("title")+" 1",param:"h1"},{name:"h2",text:X._t("title")+" 2",param:"h2"},{name:"h3",text:X._t("title")+" 3",param:"h3"}];m.prototype.setActive=function(n,o){m.__super__.setActive.call(this,n);this.el.removeClass("active-p active-h1 active-h2 active-h3");if(n){return this.el.addClass("active active-"+o)}};m.prototype.status=function(o){var n,p;if(o!=null){this.setDisabled(o.is(this.disableTag))}if(this.disabled){return true}if(o!=null){n=(p=o[0].tagName)!=null?p.toLowerCase():void 0;this.setActive(o.is(this.htmlTag),n)}return this.active};m.prototype.command=function(s){var v,r,p,w,u,x,t,n,q,y,o;x=this.editor.selection.getRange();n=x.startContainer;w=x.endContainer;p=this.editor.util.closestBlockEl(n);r=this.editor.util.closestBlockEl(w);this.editor.selection.save();x.setStartBefore(p[0]);x.setEndAfter(r[0]);v=V(x.extractContents());t=[];v.children().each((function(z){return function(Ab,Aa){var Ae,Af,Ac,Ag,Ad;Af=z._convertEl(Aa,s);Ad=[];for(Ac=0,Ag=Af.length;Ac<Ag;Ac++){Ae=Af[Ac];Ad.push(t.push(Ae))}return Ad}})(this));o=t.reverse();for(q=0,y=o.length;q<y;q++){u=o[q];x.insertNode(u[0])}this.editor.selection.restore();return this.editor.trigger("valuechanged")};m.prototype._convertEl=function(n,p){var o,q,r;q=V(n);r=[];if(q.is(p)){r.push(q)}else{o=V("<"+p+"/>").append(q.contents());r.push(o)}return r};return m})(N);X.Toolbar.addButton(P);var Q,B={}.hasOwnProperty,R=function(m,n){for(var l in n){if(B.call(n,l)){m[l]=n[l]}}function o(){this.constructor=m}o.prototype=n.prototype;m.prototype=new o();m.__super__=n.prototype;return m};Q=(function(m){R(l,m);function l(){return l.__super__.constructor.apply(this,arguments)}l.prototype.name="bold";l.prototype.icon="bold";l.prototype.title=X._t("bold");l.prototype.htmlTag="b, strong";l.prototype.disableTag="pre";l.prototype.shortcut="cmd+66";l.prototype.render=function(){if(this.editor.util.os.mac){this.title=this.title+" ( Cmd + b )"}else{this.title=this.title+" ( Ctrl + b )";this.shortcut="ctrl+66"}return l.__super__.render.call(this)};l.prototype.status=function(o){var n;if(o!=null){this.setDisabled(o.is(this.disableTag))}if(this.disabled){return true}n=document.queryCommandState("bold")===true;this.setActive(n);return n};l.prototype.command=function(){document.execCommand("bold");this.editor.trigger("valuechanged");return V(document).trigger("selectionchange")};return l})(N);X.Toolbar.addButton(Q);var e,B={}.hasOwnProperty,R=function(m,n){for(var l in n){if(B.call(n,l)){m[l]=n[l]}}function o(){this.constructor=m}o.prototype=n.prototype;m.prototype=new o();m.__super__=n.prototype;return m};e=(function(m){R(l,m);function l(){return l.__super__.constructor.apply(this,arguments)}l.prototype.name="italic";l.prototype.icon="italic";l.prototype.title=X._t("italic");l.prototype.htmlTag="i";l.prototype.disableTag="pre";l.prototype.shortcut="cmd+73";l.prototype.render=function(){if(this.editor.util.os.mac){this.title=this.title+" ( Cmd + i )"}else{this.title=this.title+" ( Ctrl + i )";this.shortcut="ctrl+73"}return l.__super__.render.call(this)};l.prototype.status=function(o){var n;if(o!=null){this.setDisabled(o.is(this.disableTag))}if(this.disabled){return this.disabled}n=document.queryCommandState("italic")===true;this.setActive(n);return n};l.prototype.command=function(){document.execCommand("italic");this.editor.trigger("valuechanged");return V(document).trigger("selectionchange")};return l})(N);X.Toolbar.addButton(e);var k,B={}.hasOwnProperty,R=function(m,n){for(var l in n){if(B.call(n,l)){m[l]=n[l]}}function o(){this.constructor=m}o.prototype=n.prototype;m.prototype=new o();m.__super__=n.prototype;return m};k=(function(m){R(l,m);function l(){return l.__super__.constructor.apply(this,arguments)}l.prototype.name="underline";l.prototype.icon="underline";l.prototype.title=X._t("underline");l.prototype.htmlTag="u";l.prototype.disableTag="pre";l.prototype.shortcut="cmd+85";l.prototype.render=function(){if(this.editor.util.os.mac){this.title=this.title+" ( Cmd + u )"}else{this.title=this.title+" ( Ctrl + u )";this.shortcut="ctrl+85"}return l.__super__.render.call(this)};l.prototype.status=function(o){var n;if(o!=null){this.setDisabled(o.is(this.disableTag))}if(this.disabled){return this.disabled}n=document.queryCommandState("underline")===true;this.setActive(n);return n};l.prototype.command=function(){document.execCommand("underline");this.editor.trigger("valuechanged");return V(document).trigger("selectionchange")};return l})(N);X.Toolbar.addButton(k);var U,B={}.hasOwnProperty,R=function(m,n){for(var l in n){if(B.call(n,l)){m[l]=n[l]}}function o(){this.constructor=m}o.prototype=n.prototype;m.prototype=new o();m.__super__=n.prototype;return m},O=[].slice;U=(function(m){R(l,m);function l(){return l.__super__.constructor.apply(this,arguments)}l.prototype.name="color";l.prototype.icon="font";l.prototype.title=X._t("color");l.prototype.disableTag="pre";l.prototype.menu=true;l.prototype.render=function(){var n;n=1<=arguments.length?O.call(arguments,0):[];return l.__super__.render.apply(this,n)};l.prototype.renderMenu=function(){V('<ul class="color-list">\n  <li><a href="javascript:;" class="font-color font-color-1" data-color=""></a></li>\n  <li><a href="javascript:;" class="font-color font-color-2" data-color=""></a></li>\n  <li><a href="javascript:;" class="font-color font-color-3" data-color=""></a></li>\n  <li><a href="javascript:;" class="font-color font-color-4" data-color=""></a></li>\n  <li><a href="javascript:;" class="font-color font-color-5" data-color=""></a></li>\n  <li><a href="javascript:;" class="font-color font-color-6" data-color=""></a></li>\n  <li><a href="javascript:;" class="font-color font-color-7" data-color=""></a></li>\n  <li><a href="javascript:;" class="font-color font-color-default" data-color=""></a></li>\n</ul>').appendTo(this.menuWrapper);this.menuWrapper.on("mousedown",".color-list",function(n){return false});return this.menuWrapper.on("click",".font-color",(function(n){return function(p){var s,o,q,r;n.wrapper.removeClass("menu-on");s=V(p.currentTarget);if(s.hasClass("font-color-default")){o=n.editor.body.find("p, li");if(!(o.length>0)){return}r=window.getComputedStyle(o[0],null).getPropertyValue("color");q=n._convertRgbToHex(r)}else{r=window.getComputedStyle(s[0],null).getPropertyValue("background-color");q=n._convertRgbToHex(r)}if(!q){return}document.execCommand("foreColor",false,q);return n.editor.trigger("valuechanged")}})(this))};l.prototype._convertRgbToHex=function(q){var p,n,o;n=/rgb\((\d+),\s?(\d+),\s?(\d+)\)/g;p=n.exec(q);if(!p){return""}o=function(t,s,v){var u;u=function(w){var r;r=w.toString(16);if(r.length===1){return"0"+r}else{return r}};return"#"+u(t)+u(s)+u(v)};return o(p[1]*1,p[2]*1,p[3]*1)};return l})(N);X.Toolbar.addButton(U);var C,h,f,B={}.hasOwnProperty,R=function(m,n){for(var l in n){if(B.call(n,l)){m[l]=n[l]}}function o(){this.constructor=m}o.prototype=n.prototype;m.prototype=new o();m.__super__=n.prototype;return m};C=(function(l){R(m,l);function m(){return m.__super__.constructor.apply(this,arguments)}m.prototype.type="";m.prototype.disableTag="pre, table";m.prototype.status=function(o){var n;if(o!=null){this.setDisabled(o.is(this.disableTag))}if(this.disabled){return true}if(o==null){return this.active}n=this.type==="ul"?"ol":"ul";if(o.is(n)){this.setActive(false);return true}else{this.setActive(o.is(this.htmlTag));return this.active}};m.prototype.command=function(y){var n,u,Ab,p,q,z,x,s,v,Aa,o,Ae,Ac,Ad,r,t,w;o=this.editor.selection.getRange();Ad=o.startContainer;s=o.endContainer;z=this.editor.util.closestBlockEl(Ad);u=this.editor.util.closestBlockEl(s);this.editor.selection.save();o.setStartBefore(z[0]);o.setEndAfter(u[0]);if(z.is("li")&&u.is("li")){p=this.editor.util.furthestNode(z,"ul, ol");Ab=this.editor.util.furthestNode(u,"ul, ol");if(p.is(Ab)){v=function(Ag){var Af;Af=1;while(!Ag.parent().is(p)){Af+=1;Ag=Ag.parent()}return Af};Ac=v(z);x=v(u);if(Ac>x){q=u.parent()}else{q=z.parent()}o.setStartBefore(q[0]);o.setEndAfter(q[0])}else{o.setStartBefore(p[0]);o.setEndAfter(Ab[0])}}n=V(o.extractContents());Ae=[];n.children().each((function(Af){return function(Ah,Ag){var Ak,Al,Ai,Am,Aj;Al=Af._convertEl(Ag);Aj=[];for(Ai=0,Am=Al.length;Ai<Am;Ai++){Ak=Al[Ai];if(Ae.length&&Ae[Ae.length-1].is(Af.type)&&Ak.is(Af.type)){Aj.push(Ae[Ae.length-1].append(Ak.children()))}else{Aj.push(Ae.push(Ak))}}return Aj}})(this));w=Ae.reverse();for(r=0,t=w.length;r<t;r++){Aa=w[r];o.insertNode(Aa[0])}this.editor.selection.restore();return this.editor.trigger("valuechanged")};m.prototype._convertEl=function(r){var w,t,s,v,q,u,n,p,o;w=V(r);u=[];t=this.type==="ul"?"ol":"ul";if(w.is(this.type)){w.children("li").each((function(x){return function(y,Aa){var Ab,Ac,z;Ac=V(Aa);Ab=Ac.children("ul, ol").remove();z=V("<p/>").append(V(Aa).html()||x.editor.util.phBr);u.push(z);if(Ab.length>0){return u.push(Ab)}}})(this))}else{if(w.is(t)){s=V("<"+this.type+"/>").append(w.html());u.push(s)}else{if(w.is("blockquote")){o=w.children().get();for(n=0,p=o.length;n<p;n++){v=o[n];q=this._convertEl(v)}V.merge(u,q)}else{if(w.is("table")){}else{s=V("<"+this.type+"><li></li></"+this.type+">");s.find("li").append(w.html()||this.editor.util.phBr);u.push(s)}}}}return u};return m})(N);h=(function(m){R(l,m);function l(){return l.__super__.constructor.apply(this,arguments)}l.prototype.type="ol";l.prototype.name="ol";l.prototype.title=X._t("ol");l.prototype.icon="list-ol";l.prototype.htmlTag="ol";l.prototype.shortcut="cmd+191";l.prototype.render=function(){if(this.editor.util.os.mac){this.title=this.title+" ( Cmd + / )"}else{this.title=this.title+" ( ctrl + / )";this.shortcut="ctrl+191"}return l.__super__.render.call(this)};return l})(C);f=(function(m){R(l,m);function l(){return l.__super__.constructor.apply(this,arguments)}l.prototype.type="ul";l.prototype.name="ul";l.prototype.title=X._t("ul");l.prototype.icon="list-ul";l.prototype.htmlTag="ul";l.prototype.shortcut="cmd+190";l.prototype.render=function(){if(this.editor.util.os.mac){this.title=this.title+" ( Cmd + . )"}else{this.title=this.title+" ( Ctrl + . )";this.shortcut="ctrl+190"}return l.__super__.render.call(this)};return l})(C);X.Toolbar.addButton(h);X.Toolbar.addButton(f);var a,B={}.hasOwnProperty,R=function(m,n){for(var l in n){if(B.call(n,l)){m[l]=n[l]}}function o(){this.constructor=m}o.prototype=n.prototype;m.prototype=new o();m.__super__=n.prototype;return m};a=(function(l){R(m,l);function m(){return m.__super__.constructor.apply(this,arguments)}m.prototype.name="blockquote";m.prototype.icon="quote-left";m.prototype.title=X._t("blockquote");m.prototype.htmlTag="blockquote";m.prototype.disableTag="pre, table";m.prototype.command=function(){var s,r,p,w,u,x,t,n,q,v,o;x=this.editor.selection.getRange();n=x.startContainer;w=x.endContainer;p=this.editor.util.furthestBlockEl(n);r=this.editor.util.furthestBlockEl(w);this.editor.selection.save();x.setStartBefore(p[0]);x.setEndAfter(r[0]);s=V(x.extractContents());t=[];s.children().each((function(y){return function(Aa,z){var Ad,Ae,Ab,Af,Ac;Ae=y._convertEl(z);Ac=[];for(Ab=0,Af=Ae.length;Ab<Af;Ab++){Ad=Ae[Ab];if(t.length&&t[t.length-1].is(y.htmlTag)&&Ad.is(y.htmlTag)){Ac.push(t[t.length-1].append(Ad.children()))}else{Ac.push(t.push(Ad))}}return Ac}})(this));o=t.reverse();for(q=0,v=o.length;q<v;q++){u=o[q];x.insertNode(u[0])}this.editor.selection.restore();return this.editor.trigger("valuechanged")};m.prototype._convertEl=function(n){var p,q,o;p=V(n);o=[];if(p.is(this.htmlTag)){p.children().each((function(r){return function(s,t){return o.push(V(t))}})(this))}else{q=V("<"+this.htmlTag+"/>").append(p);o.push(q)}return o};return m})(N);X.Toolbar.addButton(a);var M,S,B={}.hasOwnProperty,R=function(m,n){for(var l in n){if(B.call(n,l)){m[l]=n[l]}}function o(){this.constructor=m}o.prototype=n.prototype;m.prototype=new o();m.__super__=n.prototype;return m},O=[].slice;M=(function(m){R(l,m);function l(){return l.__super__.constructor.apply(this,arguments)}l.prototype.name="code";l.prototype.icon="code";l.prototype.title=X._t("code");l.prototype.htmlTag="pre";l.prototype.disableTag="li, table";l.prototype._init=function(){l.__super__._init.call(this);this.editor.on("decorate",(function(n){return function(o,p){return p.find("pre").each(function(q,r){return n.decorate(V(r))})}})(this));return this.editor.on("undecorate",(function(n){return function(o,p){return p.find("pre").each(function(q,r){return n.undecorate(V(r))})}})(this))};l.prototype.render=function(){var n;n=1<=arguments.length?O.call(arguments,0):[];l.__super__.render.apply(this,n);return this.popover=new S({button:this})};l.prototype.status=function(o){var n;n=l.__super__.status.call(this,o);if(this.active){this.popover.show(o)}else{if(this.editor.util.isBlockNode(o)){this.popover.hide()}}return n};l.prototype.decorate=function(n){var o;o=n.attr("data-lang");n.removeClass();if(o&&o!==-1){return n.addClass("lang-"+o)}};l.prototype.undecorate=function(n){var o;o=n.attr("data-lang");n.removeClass();if(o&&o!==-1){return n.addClass("lang-"+o)}};l.prototype.command=function(){var s,r,p,w,u,x,t,n,q,v,o;x=this.editor.selection.getRange();n=x.startContainer;w=x.endContainer;p=this.editor.util.closestBlockEl(n);r=this.editor.util.closestBlockEl(w);x.setStartBefore(p[0]);x.setEndAfter(r[0]);s=V(x.extractContents());t=[];s.children().each((function(y){return function(Aa,z){var Ad,Ae,Ab,Af,Ac;Ae=y._convertEl(z);Ac=[];for(Ab=0,Af=Ae.length;Ab<Af;Ab++){Ad=Ae[Ab];if(t.length&&t[t.length-1].is(y.htmlTag)&&Ad.is(y.htmlTag)){Ac.push(t[t.length-1].append(Ad.contents()))}else{Ac.push(t.push(Ad))}}return Ac}})(this));o=t.reverse();for(q=0,v=o.length;q<v;q++){u=o[q];x.insertNode(u[0])}this.editor.selection.setRangeAtEndOf(t[0]);return this.editor.trigger("valuechanged")};l.prototype._convertEl=function(n){var q,r,p,o;q=V(n);o=[];if(q.is(this.htmlTag)){r=V("<p/>").append(q.html().replace("\n","<br/>"));o.push(r)}else{if(!q.text()&&q.children().length===1&&q.children().is("br")){p="\n"}else{p=this.editor.formatter.clearHtml(q)}r=V("<"+this.htmlTag+"/>").text(p);o.push(r)}return o};return l})(N);S=(function(l){R(m,l);function m(){return m.__super__.constructor.apply(this,arguments)}m.prototype._tpl='<div class="code-settings">\n  <div class="settings-field">\n    <select class="select-lang">\n      <option value="-1">选择程序语言</option>\n      <option value="c++">C++</option>\n      <option value="css">CSS</option>\n      <option value="coffeeScript">CoffeeScript</option>\n      <option value="html">Html,XML</option>\n      <option value="json">JSON</option>\n      <option value="java">Java</option>\n      <option value="js">JavaScript</option>\n      <option value="markdown">Markdown</option>\n      <option value="oc">Objective C</option>\n      <option value="php">PHP</option>\n      <option value="perl">Perl</option>\n      <option value="python">Python</option>\n      <option value="ruby">Ruby</option>\n      <option value="sql">SQL</option>\n    </select>\n  </div>\n</div>';m.prototype.render=function(){this.el.addClass("code-popover").append(this._tpl);this.selectEl=this.el.find(".select-lang");return this.selectEl.on("change",(function(n){return function(o){var p;n.lang=n.selectEl.val();p=n.target.hasClass("selected");n.target.removeClass().removeAttr("data-lang");if(n.lang!==-1){n.target.addClass("lang-"+n.lang);n.target.attr("data-lang",n.lang)}if(p){return n.target.addClass("selected")}}})(this))};m.prototype.show=function(){var n;n=1<=arguments.length?O.call(arguments,0):[];m.__super__.show.apply(this,n);this.lang=this.target.attr("data-lang");if(this.lang!=null){return this.selectEl.val(this.lang)}else{return this.selectEl.val(-1)}};return m})(I);X.Toolbar.addButton(M);var b,g,B={}.hasOwnProperty,R=function(m,n){for(var l in n){if(B.call(n,l)){m[l]=n[l]}}function o(){this.constructor=m}o.prototype=n.prototype;m.prototype=new o();m.__super__=n.prototype;return m},O=[].slice;b=(function(m){R(l,m);function l(){return l.__super__.constructor.apply(this,arguments)}l.prototype.name="link";l.prototype.icon="link";l.prototype.title=X._t("insertLink");l.prototype.htmlTag="a";l.prototype.disableTag="pre";l.prototype.render=function(){var n;n=1<=arguments.length?O.call(arguments,0):[];l.__super__.render.apply(this,n);return this.popover=new g({button:this})};l.prototype.status=function(o){var n;if(o!=null){this.setDisabled(o.is(this.disableTag))}if(this.disabled){return true}if(o==null){return this.active}n=true;if(!o.is(this.htmlTag)||o.is('[class^="simditor-"]')){this.setActive(false);n=false}else{if(this.editor.selection.rangeAtEndOf(o)){this.setActive(true);n=false}else{this.setActive(true)}}if(n){this.popover.show(o)}else{if(this.editor.util.isBlockNode(o)){this.popover.hide()}}return this.active};l.prototype.command=function(){var s,o,n,r,p,v,q,w,t,u;w=this.editor.selection.getRange();if(this.active){n=V(w.commonAncestorContainer).closest("a");u=document.createTextNode(n.text());n.replaceWith(u);w.selectNode(u)}else{t=w.startContainer;v=w.endContainer;p=this.editor.util.closestBlockEl(t);o=this.editor.util.closestBlockEl(v);s=V(w.extractContents());q=this.editor.formatter.clearHtml(s.contents(),false);n=V("<a/>",{href:"http://www.example.com",target:"_blank",text:q||X._t("linkText")});if(p[0]===o[0]){w.insertNode(n[0])}else{r=V("<p/>").append(n);w.insertNode(r[0])}w.selectNodeContents(n[0]);this.popover.one("popovershow",(function(x){return function(){if(q){x.popover.urlEl.focus();return x.popover.urlEl[0].select()}else{x.popover.textEl.focus();return x.popover.textEl[0].select()}}})(this))}this.editor.selection.selectRange(w);return this.editor.trigger("valuechanged")};return l})(N);g=(function(m){R(l,m);function l(){return l.__super__.constructor.apply(this,arguments)}l.prototype._tpl='<div class="link-settings">\n  <div class="settings-field">\n    <label>'+(X._t("text"))+'</label>\n    <input class="link-text" type="text"/>\n    <a class="btn-unlink" href="javascript:;" title="'+(X._t("removeLink"))+'" tabindex="-1"><span class="fa fa-unlink"></span></a>\n  </div>\n  <div class="settings-field">\n    <label>'+(X._t("linkUrl"))+'</label>\n    <input class="link-url" type="text"/>\n  </div>\n</div>';l.prototype.render=function(){this.el.addClass("link-popover").append(this._tpl);this.textEl=this.el.find(".link-text");this.urlEl=this.el.find(".link-url");this.unlinkEl=this.el.find(".btn-unlink");this.textEl.on("keyup",(function(n){return function(o){if(o.which===13){return}return n.target.text(n.textEl.val())}})(this));this.urlEl.on("keyup",(function(n){return function(o){var p;if(o.which===13){return}p=n.urlEl.val();if(!(/https?:\/\/|^\//ig.test(p)||!p)){p="http://"+p}return n.target.attr("href",p)}})(this));V([this.urlEl[0],this.textEl[0]]).on("keydown",(function(n){return function(o){if(o.which===13||o.which===27||(!o.shiftKey&&o.which===9&&V(o.target).hasClass("link-url"))){o.preventDefault();return setTimeout(function(){var p;p=document.createRange();n.editor.selection.setRangeAfter(n.target,p);n.hide();return n.editor.trigger("valuechanged")},0)}}})(this));return this.unlinkEl.on("click",(function(n){return function(p){var q,o;o=document.createTextNode(n.target.text());n.target.replaceWith(o);n.hide();q=document.createRange();n.editor.selection.setRangeAfter(o,q);return n.editor.trigger("valuechanged")}})(this))};l.prototype.show=function(){var n;n=1<=arguments.length?O.call(arguments,0):[];l.__super__.show.apply(this,n);this.textEl.val(this.target.text());return this.urlEl.val(this.target.attr("href"))};return l})(I);X.Toolbar.addButton(b);var A,i,B={}.hasOwnProperty,R=function(m,n){for(var l in n){if(B.call(n,l)){m[l]=n[l]}}function o(){this.constructor=m}o.prototype=n.prototype;m.prototype=new o();m.__super__=n.prototype;return m},O=[].slice;A=(function(l){R(m,l);function m(){return m.__super__.constructor.apply(this,arguments)}m.prototype.name="image";m.prototype.icon="picture-o";m.prototype.title=X._t("insertImage");m.prototype.htmlTag="img";m.prototype.disableTag="pre, table";m.prototype.defaultImage="";m.prototype.needFocus=false;m.prototype.menu=[{name:"upload-image",text:X._t("localImage")},{name:"external-image",text:X._t("externalImage")}];m.prototype._init=function(){if(this.editor.uploader==null){this.menu=false}m.__super__._init.call(this);this.defaultImage=this.editor.opts.defaultImage;this.editor.body.on("click","img:not([data-non-image])",(function(n){return function(o){var p,q;p=V(o.currentTarget);q=document.createRange();q.selectNode(p[0]);n.editor.selection.selectRange(q);if(!n.editor.util.supportSelectionChange){n.editor.trigger("selectionchanged")}return false}})(this));this.editor.body.on("mouseup","img:not([data-non-image])",(function(n){return function(o){return false}})(this));this.editor.on("selectionchanged.image",(function(n){return function(){var o,p,q;q=n.editor.selection.sel.getRangeAt(0);if(q==null){return}o=V(q.cloneContents()).contents();if(o.length===1&&o.is("img:not([data-non-image])")){p=V(q.startContainer).contents().eq(q.startOffset);return n.popover.show(p)}else{return n.popover.hide()}}})(this));return this.editor.on("valuechanged.image",(function(n){return function(){var o;o=n.editor.wrapper.find(".simditor-image-loading");if(!(o.length>0)){return}return o.each(function(p,s){var r,q,t;q=V(s);r=q.data("img");if(!(r&&r.parent().length>0)){q.remove();if(r){t=r.data("file");if(t){n.editor.uploader.cancel(t);if(n.editor.body.find("img.uploading").length<1){return n.editor.uploader.trigger("uploadready",[t])}}}}})}})(this))};m.prototype.render=function(){var n;n=1<=arguments.length?O.call(arguments,0):[];m.__super__.render.apply(this,n);return this.popover=new i({button:this})};m.prototype.renderMenu=function(){var n,o,p;m.__super__.renderMenu.call(this);o=this.menuEl.find(".menu-item-upload-image");n=null;p=(function(q){return function(){if(n){n.remove()}return n=V('<input type="file" title="'+X._t("uploadImage")+'" accept="image/*">').appendTo(o)}})(this);p();o.on("click mousedown","input[type=file]",(function(q){return function(r){return r.stopPropagation()}})(this));o.on("change","input[type=file]",(function(q){return function(r){if(q.editor.inputManager.focused){q.editor.uploader.upload(n,{inline:true});p()}else{q.editor.one("focus",function(s){q.editor.uploader.upload(n,{inline:true});return p()});q.editor.focus()}return q.wrapper.removeClass("menu-on")}})(this));return this._initUploader()};m.prototype._initUploader=function(){if(this.editor.uploader==null){this.el.find(".btn-upload").remove();return}this.editor.uploader.on("beforeupload",(function(n){return function(o,q){var p;if(!q.inline){return}if(q.img){p=V(q.img)}else{p=n.createImage(q.name);q.img=p}p.addClass("uploading");p.data("file",q);return n.editor.uploader.readImageFile(q.obj,function(s){var r;if(!p.hasClass("uploading")){return}r=s?s.src:n.defaultImage;return n.loadImage(p,r,function(){n.popover.refresh();return n.popover.srcEl.val("正在上传...").prop("disabled",true)})})}})(this));this.editor.uploader.on("uploadprogress",(function(n){return function(q,t,p,r){var s,u,o;if(!t.inline){return}o=p/r;o=(o*100).toFixed(0);if(o>99){o=99}u=t.img.data("mask");if(u){s=u.data("img");if(s&&s.parent().length>0){return u.find("span").text(o)}else{return u.remove()}}}})(this));this.editor.uploader.on("uploadsuccess",(function(n){return function(o,s,p){var q,t,r;if(!s.inline){return}q=s.img;q.removeData("file");q.removeClass("uploading");t=q.data("mask");if(t){t.remove()}q.removeData("mask");if(p.success===false){r=p.msg||X._t("uploadFailed");alert(r);q.attr("src",n.defaultImage)}else{q.attr("src",p.file_path)}n.popover.srcEl.prop("disabled",false);n.editor.trigger("valuechanged");if(n.editor.body.find("img.uploading").length<1){return n.editor.uploader.trigger("uploadready",[s,p])}}})(this));return this.editor.uploader.on("uploaderror",(function(n){return function(o,v,s){var u,p,t,q;if(!v.inline){return}if(s.statusText==="abort"){return}if(s.responseText){try{q=V.parseJSON(s.responseText);t=q.msg}catch(r){o=r;t=X._t("uploadError")}alert(t)}u=v.img;u.removeData("file");u.removeClass("uploading");p=u.data("mask");if(p){p.remove()}u.removeData("mask");u.attr("src",n.defaultImage);n.popover.srcEl.prop("disabled",false);n.editor.trigger("valuechanged");if(n.editor.body.find("img.uploading").length<1){return n.editor.uploader.trigger("uploadready",[v,q])}}})(this))};m.prototype.status=function(n){if(n!=null){this.setDisabled(n.is(this.disableTag))}if(this.disabled){return true}};m.prototype.loadImage=function(p,q,n){var o,r;o=p.data("mask");if(!o){o=V('<div class="simditor-image-loading"><span></span></div>').hide().appendTo(this.editor.wrapper);if(p.hasClass("uploading")){o.addClass("uploading")}p.data("mask",o);o.data("img",p)}r=new Image();r.onload=(function(s){return function(){var t,v,w,u;w=r.width;t=r.height;p.attr({src:q,"data-image-size":w+","+t});if(p.hasClass("uploading")){s.editor.util.reflow(s.editor.body);u=s.editor.wrapper.offset();v=p.offset();o.css({top:v.top-u.top,left:v.left-u.left,width:p.width(),height:p.height()}).show()}else{o.remove();p.removeData("mask")}return n(r)}})(this);r.onerror=(function(s){return function(){n(false);o.remove();return p.removeData("mask")}})(this);return r.src=q};m.prototype.createImage=function(p){var o,q,n,r;if(p==null){p="Image"}if(!this.editor.inputManager.focused){this.editor.focus()}r=this.editor.selection.getRange();r.deleteContents();o=this.editor.util.closestBlockEl();if(o.is("p")&&!this.editor.util.isEmptyNode(o)){o=V("<p/>").append(this.editor.util.phBr).insertAfter(o);this.editor.selection.setRangeAtStartOf(o,r)}q=V("<img/>").attr("alt",p);r.insertNode(q[0]);n=o.next("p");if(!(n.length>0)){n=V("<p/>").append(this.editor.util.phBr).insertAfter(o)}this.editor.selection.setRangeAtStartOf(n);return q};m.prototype.command=function(o){var n;n=this.createImage();return this.loadImage(n,o||this.defaultImage,(function(p){return function(){p.editor.trigger("valuechanged");p.editor.util.reflow(n);n.click();return p.popover.one("popovershow",function(){p.popover.srcEl.focus();return p.popover.srcEl[0].select()})}})(this))};return m})(N);i=(function(l){R(m,l);function m(){return m.__super__.constructor.apply(this,arguments)}m.prototype._tpl='<div class="link-settings">\n  <div class="settings-field">\n    <label>'+(X._t("imageUrl"))+'</label>\n    <input class="image-src" type="text" tabindex="1" />\n    <a class="btn-upload" href="javascript:;" title="'+(X._t("uploadImage"))+'" tabindex="-1">\n      <span class="fa fa-upload"></span>\n    </a>\n  </div>\n  <div class="settings-field">\n    <label>'+(X._t("imageSize"))+'</label>\n    <input class="image-size" id="image-width" type="text" tabindex="2" />\n    <span class="times">×</span>\n    <input class="image-size" id="image-height" type="text" tabindex="3" />\n    <a class="btn-restore" href="javascript:;" title="'+(X._t("restoreImageSize"))+'" tabindex="-1">\n      <span class="fa fa-reply"></span>\n    </a>\n  </div>\n</div>';m.prototype.offset={top:6,left:-4};m.prototype.render=function(){this.el.addClass("image-popover").append(this._tpl);this.srcEl=this.el.find(".image-src");this.srcEl.on("keydown",(function(n){return function(o){var p;if(o.which===13||o.which===27){o.preventDefault();if(o.which===13&&!n.target.hasClass("uploading")){p=n.srcEl.val();return n.button.loadImage(n.target,p,function(q){if(!q){return}n.button.editor.body.focus();n.button.editor.selection.setRangeAfter(n.target);n.hide();return n.editor.trigger("valuechanged")})}else{n.button.editor.body.focus();n.button.editor.selection.setRangeAfter(n.target);return n.hide()}}}})(this));this.widthEl=this.el.find("#image-width");this.heightEl=this.el.find("#image-height");this.el.find(".image-size").on("blur",(function(n){return function(o){n._resizeImg(V(o.currentTarget));return n.el.data("popover").refresh()}})(this));this.el.find(".image-size").on("keyup",(function(n){return function(p){var o;o=V(p.currentTarget);if(!(p.which===13||p.which===27||p.which===9)){return n._resizeImg(o,true)}}})(this));this.el.find(".image-size").on("keydown",(function(n){return function(p){var o;o=V(p.currentTarget);if(p.which===13||p.which===27){p.preventDefault();if(p.which===13){n._resizeImg(o)}else{n._restoreImg()}n.button.editor.body.focus();n.button.editor.selection.setRangeAfter(n.target);return n.hide()}else{if(p.which===9){return n.el.data("popover").refresh()}}}})(this));this.el.find(".btn-restore").on("click",(function(n){return function(o){n._restoreImg();return n.el.data("popover").refresh()}})(this));this.editor.on("valuechanged",(function(n){return function(o){if(n.active){return n.refresh()}}})(this));return this._initUploader()};m.prototype._initUploader=function(){var n,o;n=this.el.find(".btn-upload");if(this.editor.uploader==null){n.remove();return}o=(function(p){return function(){if(p.input){p.input.remove()}return p.input=V('<input type="file" title="'+X._t("uploadImage")+'" accept="image/*">').appendTo(n)}})(this);o();this.el.on("click mousedown","input[type=file]",(function(p){return function(q){return q.stopPropagation()}})(this));return this.el.on("change","input[type=file]",(function(p){return function(q){p.editor.uploader.upload(p.input,{inline:true,img:p.target});return o()}})(this))};m.prototype._resizeImg=function(n,p){var o,q,r;if(p==null){p=false}q=n.val()*1;if(!(V.isNumeric(q)||q<0)){return}if(n.is(this.widthEl)){o=this.height*q/this.width;this.heightEl.val(o)}else{r=this.width*q/this.height;this.widthEl.val(r)}if(!p){return this.target.attr({width:r||q,height:o||q})}};m.prototype._restoreImg=function(){var n,o;n=((o=this.target.data("image-size"))!=null?o.split(","):void 0)||[this.width,this.height];this.target.attr({width:n[0]*1,height:n[1]*1});this.widthEl.val(n[0]);return this.heightEl.val(n[1])};m.prototype.show=function(){var n,o;o=1<=arguments.length?O.call(arguments,0):[];m.__super__.show.apply(this,o);n=this.target;this.width=n.width();this.height=n.height();if(n.hasClass("uploading")){return this.srcEl.val(X._t("uploading"))}else{this.srcEl.val(n.attr("src"));this.widthEl.val(this.width);return this.heightEl.val(this.height)}};return m})(I);X.Toolbar.addButton(A);var J,B={}.hasOwnProperty,R=function(m,n){for(var l in n){if(B.call(n,l)){m[l]=n[l]}}function o(){this.constructor=m}o.prototype=n.prototype;m.prototype=new o();m.__super__=n.prototype;return m};J=(function(l){R(m,l);function m(){return m.__super__.constructor.apply(this,arguments)}m.prototype.name="indent";m.prototype.icon="indent";m.prototype.title=X._t("indent")+" (Tab)";m.prototype.status=function(n){return true};m.prototype.command=function(){return this.editor.util.indent()};return m})(N);X.Toolbar.addButton(J);var F,B={}.hasOwnProperty,R=function(m,n){for(var l in n){if(B.call(n,l)){m[l]=n[l]}}function o(){this.constructor=m}o.prototype=n.prototype;m.prototype=new o();m.__super__=n.prototype;return m};F=(function(l){R(m,l);function m(){return m.__super__.constructor.apply(this,arguments)}m.prototype.name="outdent";m.prototype.icon="outdent";m.prototype.title=X._t("outdent")+" (Shift + Tab)";m.prototype.status=function(n){return true};m.prototype.command=function(){return this.editor.util.outdent()};return m})(N);X.Toolbar.addButton(F);var G,B={}.hasOwnProperty,R=function(m,n){for(var l in n){if(B.call(n,l)){m[l]=n[l]}}function o(){this.constructor=m}o.prototype=n.prototype;m.prototype=new o();m.__super__=n.prototype;return m};G=(function(m){R(l,m);function l(){return l.__super__.constructor.apply(this,arguments)}l.prototype.name="hr";l.prototype.icon="minus";l.prototype.title=X._t("hr");l.prototype.htmlTag="hr";l.prototype.status=function(n){return true};l.prototype.command=function(){var n,q,o,p;p=this.editor.util.furthestBlockEl();o=p.next();if(o.length>0){this.editor.selection.save()}else{q=V("<p/>").append(this.editor.util.phBr)}n=V("<hr/>").insertAfter(p);if(q){q.insertAfter(n);this.editor.selection.setRangeAtStartOf(q)}else{this.editor.selection.restore()}return this.editor.trigger("valuechanged")};return l})(N);X.Toolbar.addButton(G);var d,B={}.hasOwnProperty,R=function(m,n){for(var l in n){if(B.call(n,l)){m[l]=n[l]}}function o(){this.constructor=m}o.prototype=n.prototype;m.prototype=new o();m.__super__=n.prototype;return m};d=(function(l){R(m,l);function m(){return m.__super__.constructor.apply(this,arguments)}m.prototype.name="table";m.prototype.icon="table";m.prototype.title=X._t("table");m.prototype.htmlTag="table";m.prototype.disableTag="pre, li, blockquote";m.prototype.menu=true;m.prototype._init=function(){m.__super__._init.call(this);V.merge(this.editor.formatter._allowedTags,["tbody","tr","td","colgroup","col"]);V.extend(this.editor.formatter._allowedAttributes,{td:["rowspan","colspan"],col:["width"]});this.editor.on("decorate",(function(n){return function(o,p){return p.find("table").each(function(q,r){return n.decorate(V(r))})}})(this));this.editor.on("undecorate",(function(n){return function(o,p){return p.find("table").each(function(q,r){return n.undecorate(V(r))})}})(this));this.editor.on("selectionchanged.table",(function(n){return function(o){var q,p;n.editor.body.find(".simditor-table td").removeClass("active");p=n.editor.selection.getRange();if(p==null){return}q=V(p.commonAncestorContainer);if(p.collapsed&&q.is(".simditor-table")){if(n.editor.selection.rangeAtStartOf(q)){q=q.find("td:first")}else{q=q.find("td:last")}n.editor.selection.setRangeAtEndOf(q)}return q.closest("td",n.editor.body).addClass("active")}})(this));this.editor.on("blur.table",(function(n){return function(o){return n.editor.body.find(".simditor-table td").removeClass("active")}})(this));this.editor.inputManager.addKeystrokeHandler("38","td",(function(n){return function(p,r){var s,o,q;o=r.parent("tr");s=o.prev("tr");if(!(s.length>0)){return true}q=o.find("td").index(r);n.editor.selection.setRangeAtEndOf(s.find("td").eq(q));return true}})(this));return this.editor.inputManager.addKeystrokeHandler("40","td",(function(n){return function(p,s){var o,r,q;r=s.parent("tr");o=r.next("tr");if(!(o.length>0)){return true}q=r.find("td").index(s);n.editor.selection.setRangeAtEndOf(o.find("td").eq(q));return true}})(this))};m.prototype.initResize=function(p){var q,o,n;n=p.parent(".simditor-table");q=p.find("colgroup");if(q.length<1){q=V("<colgroup/>").prependTo(p);p.find("tr:first td").each((function(r){return function(s,u){var t;return t=V("<col/>").appendTo(q)}})(this));this.refreshTableWidth(p)}o=V('<div class="simditor-resize-handle" contenteditable="false"></div>').appendTo(n);n.on("mousemove","td",(function(r){return function(s){var t,u,y,w,v,z;if(n.hasClass("resizing")){return}u=V(s.currentTarget);w=s.pageX-V(s.currentTarget).offset().left;if(w<5&&u.prev().length>0){u=u.prev()}if(u.next("td").length<1){o.hide();return}if((v=o.data("td"))!=null?v.is(u):void 0){o.show();return}y=u.parent().find("td").index(u);t=q.find("col").eq(y);if((z=o.data("col"))!=null?z.is(t):void 0){o.show();return}return o.css("left",u.position().left+u.outerWidth()-5).data("td",u).data("col",t).show()}})(this));n.on("mouseleave",(function(r){return function(s){return o.hide()}})(this));return n.on("mousedown",".simditor-resize-handle",(function(r){return function(u){var Ab,Ac,w,v,s,Ad,y,Aa,t,z,x;Ab=V(u.currentTarget);w=Ab.data("td");Ac=Ab.data("col");s=w.next("td");v=Ac.next("col");z=u.pageX;Aa=w.outerWidth()*1;t=s.outerWidth()*1;y=parseFloat(Ab.css("left"));x=w.closest("table").width();Ad=50;V(document).on("mousemove.simditor-resize-table",function(Ag){var Ah,Af,Ae;Ah=Ag.pageX-z;Af=Aa+Ah;Ae=t-Ah;if(Af<Ad){Af=Ad;Ah=Ad-Aa;Ae=t-Ah}else{if(Ae<Ad){Ae=Ad;Ah=t-Ad;Af=Aa+Ah}}Ac.attr("width",(Af/x*100)+"%");v.attr("width",(Ae/x*100)+"%");return Ab.css("left",y+Ah)});V(document).one("mouseup.simditor-resize-table",function(Ae){V(document).off(".simditor-resize-table");return n.removeClass("resizing")});n.addClass("resizing");return false}})(this))};m.prototype.decorate=function(n){if(n.parent(".simditor-table").length>0){this.undecorate(n)}n.wrap('<div class="simditor-table"></div>');this.initResize(n);return n.parent()};m.prototype.undecorate=function(n){if(!(n.parent(".simditor-table").length>0)){return}return n.parent().replaceWith(n)};m.prototype.renderMenu=function(){V('<div class="menu-create-table">\n</div>\n<div class="menu-edit-table">\n  <ul>\n    <li><a tabindex="-1" unselectable="on" class="menu-item" href="javascript:;" data-param="deleteRow"><span>'+(X._t("deleteRow"))+'</span></a></li>\n    <li><a tabindex="-1" unselectable="on" class="menu-item" href="javascript:;" data-param="insertRowAbove"><span>'+(X._t("insertRowAbove"))+'</span></a></li>\n    <li><a tabindex="-1" unselectable="on" class="menu-item" href="javascript:;" data-param="insertRowBelow"><span>'+(X._t("insertRowBelow"))+'</span></a></li>\n    <li><span class="separator"></span></li>\n    <li><a tabindex="-1" unselectable="on" class="menu-item" href="javascript:;" data-param="deleteCol"><span>'+(X._t("delteColumn"))+'</span></a></li>\n    <li><a tabindex="-1" unselectable="on" class="menu-item" href="javascript:;" data-param="insertColLeft"><span>'+(X._t("insertColumnLeft"))+'</span></a></li>\n    <li><a tabindex="-1" unselectable="on" class="menu-item" href="javascript:;" data-param="insertColRight"><span>'+(X._t("insertColumnRight"))+'</span></a></li>\n    <li><span class="separator"></span></li>\n    <li><a tabindex="-1" unselectable="on" class="menu-item" href="javascript:;" data-param="deleteTable"><span>'+(X._t("deleteTable"))+"</span></a></li>\n  </ul>\n</div>").appendTo(this.menuWrapper);this.createMenu=this.menuWrapper.find(".menu-create-table");this.editMenu=this.menuWrapper.find(".menu-edit-table");this.createTable(6,6).appendTo(this.createMenu);this.createMenu.on("mouseenter","td",(function(n){return function(p){var q,o,r;n.createMenu.find("td").removeClass("selected");q=V(p.currentTarget);o=q.parent();r=o.find("td").index(q)+1;return o.prevAll("tr").addBack().find("td:lt("+r+")").addClass("selected")}})(this));this.createMenu.on("mouseleave",(function(n){return function(o){return V(o.currentTarget).find("td").removeClass("selected")}})(this));return this.createMenu.on("mousedown","td",(function(n){return function(q){var s,t,r,p,o,u;n.wrapper.removeClass("menu-on");if(!n.editor.inputManager.focused){return}r=V(q.currentTarget);p=r.parent();o=p.find("td").index(r)+1;u=p.prevAll("tr").length+1;t=n.createTable(u,o,true);s=n.editor.util.closestBlockEl();if(n.editor.util.isEmptyNode(s)){s.replaceWith(t)}else{s.after(t)}n.decorate(t);n.editor.selection.setRangeAtStartOf(t.find("td:first"));n.editor.trigger("valuechanged");return false}})(this))};m.prototype.createTable=function(u,y,w){var x,o,p,n,v,q,s,t;x=V("<table/>");o=V("<tbody/>").appendTo(x);for(q=s=0;0<=u?s<u:s>u;q=0<=u?++s:--s){n=V("<tr/>").appendTo(o);for(v=t=0;0<=y?t<y:t>y;v=0<=y?++t:--t){p=V("<td/>").appendTo(n);if(w){p.append(this.editor.util.phBr)}}}return x};m.prototype.refreshTableWidth=function(p){var n,o;o=p.width();n=p.find("col");return p.find("tr:first td").each((function(q){return function(r,t){var s;s=n.eq(r);return s.attr("width",(V(t).outerWidth()/o*100)+"%")}})(this))};m.prototype.setActive=function(n){m.__super__.setActive.call(this,n);if(n){this.createMenu.hide();return this.editMenu.show()}else{this.createMenu.show();return this.editMenu.hide()}};m.prototype.deleteRow=function(o){var q,n,p;n=o.parent("tr");if(n.siblings("tr").length<1){return this.deleteTable(o)}else{q=n.next("tr");if(!(q.length>0)){q=n.prev("tr")}p=n.find("td").index(o);n.remove();return this.editor.selection.setRangeAtEndOf(q.find("td").eq(p))}};m.prototype.insertRow=function(o,n){var t,v,s,u,r,p,q;if(n==null){n="after"}s=o.parent("tr");v=s.closest("table");u=0;v.find("tr").each((function(w){return function(x,y){return u=Math.max(u,V(y).find("td").length)}})(this));t=V("<tr/>");for(r=q=1;1<=u?q<=u:q>=u;r=1<=u?++q:--q){V("<td/>").append(this.editor.util.phBr).appendTo(t)}s[n](t);p=s.find("td").index(o);return this.editor.selection.setRangeAtStartOf(t.find("td").eq(p))};m.prototype.deleteCol=function(p){var r,q,n,o;n=p.parent("tr");if(n.siblings("tr").length<1&&p.siblings("td").length<1){return this.deleteTable(p)}else{o=n.find("td").index(p);r=p.next("td");if(!(r.length>0)){r=n.prev("td")}q=n.closest("table");q.find("col").eq(o).remove();q.find("tr").each((function(s){return function(t,u){return V(u).find("td").eq(o).remove()}})(this));this.refreshTableWidth(q);return this.editor.selection.setRangeAtEndOf(r)}};m.prototype.insertCol=function(o,n){var q,t,r,v,s,p,w,u;if(n==null){n="after"}s=o.parent("tr");p=s.find("td").index(o);v=o.closest("table");q=v.find("col").eq(p);v.find("tr").each((function(x){return function(y,z){var Aa;Aa=V("<td/>").append(x.editor.util.phBr);return V(z).find("td").eq(p)[n](Aa)}})(this));t=V("<col/>");q[n](t);w=v.width();u=Math.max(parseFloat(q.attr("width"))/2,50/w*100);q.attr("width",u+"%");t.attr("width",u+"%");this.refreshTableWidth(v);r=n==="after"?o.next("td"):o.prev("td");return this.editor.selection.setRangeAtStartOf(r)};m.prototype.deleteTable=function(o){var n,p;p=o.closest(".simditor-table");n=p.next("p");p.remove();if(n.length>0){return this.editor.selection.setRangeAtStartOf(n)}};m.prototype.command=function(o){var n,p;p=this.editor.selection.getRange();n=V(p.commonAncestorContainer).closest("td");if(!(n.length>0)){return}if(o==="deleteRow"){this.deleteRow(n)}else{if(o==="insertRowAbove"){this.insertRow(n,"before")}else{if(o==="insertRowBelow"){this.insertRow(n)}else{if(o==="deleteCol"){this.deleteCol(n)}else{if(o==="insertColLeft"){this.insertCol(n,"before")}else{if(o==="insertColRight"){this.insertCol(n)}else{if(o==="deleteTable"){this.deleteTable(n)}else{return}}}}}}}return this.editor.trigger("valuechanged")};return m})(N);X.Toolbar.addButton(d);var D,B={}.hasOwnProperty,R=function(m,n){for(var l in n){if(B.call(n,l)){m[l]=n[l]}}function o(){this.constructor=m}o.prototype=n.prototype;m.prototype=new o();m.__super__=n.prototype;return m};D=(function(m){R(l,m);function l(){return l.__super__.constructor.apply(this,arguments)}l.prototype.name="strikethrough";l.prototype.icon="strikethrough";l.prototype.title=X._t("strikethrough");l.prototype.htmlTag="strike";l.prototype.disableTag="pre";l.prototype.status=function(o){var n;if(o!=null){this.setDisabled(o.is(this.disableTag))}if(this.disabled){return true}n=document.queryCommandState("strikethrough")===true;this.setActive(n);return n};l.prototype.command=function(){document.execCommand("strikethrough");this.editor.trigger("valuechanged");return V(document).trigger("selectionchange")};return l})(N);X.Toolbar.addButton(D);return X}));